#Region  Activity Attributes 
	#FullScreen: True
	#IncludeTitle: False
#End Region
#Extends: android.support.v7.app.AppCompatActivity
#If Java

public boolean _onCreateOptionsMenu(android.view.Menu menu) {
	if (processBA.subExists("activity_createmenu")) {
		processBA.raiseEvent2(null, true, "activity_createmenu", false, new de.amberhome.objects.appcompat.ACMenuWrapper(menu));
		return true;
	}
	else
		return false;
}
#End If

Sub Process_Globals
	Dim index As Object
	Private xui As XUI
	Dim EPSONPrint As clsPrint

	Dim BTAdmin As BluetoothAdmin
	Dim PairedDevices As Map

	Dim FoundDevices As List
	Dim DeviceName, DeviceMac As String

	Dim Serial1 As Serial
	Dim TMPrinter As TextWriter

	Dim PrintBuffer As String
	Dim PrintLogo() As Byte
	Dim oStream As AsyncStreams
	Private Res As Int
	
	Private flagBitmap As Bitmap

	Dim Logobmp As Bitmap
	Dim WoosimCmd As JavaObject
	Dim WoosimImage As JavaObject
	Dim Logo As Bitmap
	Public Permissions As RuntimePermissions
End Sub

Sub Globals
	Private Panel1 As Panel
	Dim LvEffect As ListView

	Private camEx As CameraExClass
	Private PnlFocus As Panel
	Dim cvsDrawing As Canvas
	Private api As Int
	Dim focuscolor As Double

	Private ToolBar As ACToolBarDark
	Private ActionBarButton As ACActionBar
	Private xmlIcon As XmlLayoutBuilder
	Private PopWarnings As ACPopupMenu
	Private PopSubMenu As ACPopupMenu
	Dim BookCode, BookDesc As String

	Private snack As DSSnackbar
	Dim CD As ColorDrawable

	Private strSF As StringFunctions
	Private IMEkeyboard As IME
	Private WasEdited As Boolean
	Private SV As SearchView

	'Material Dialog
	Private MatDialogBuilder As MaterialDialogBuilder
	
	'Recordset
	Private rsLoadedBook As Cursor

	Private rsUnReadAcct As Cursor
	Private rsReadAcct As Cursor
	Private rsAllAcct As Cursor
	Private rsUnusualReading As Cursor
	
	'////////////////////////////////////////////////////////////
	'UI
	Private pnlMain As Panel
	
	'Account Info
	Private pnlAccountInfo As Panel
	Private lblSeqNo As Label
	Private lblMeter As Label
	Private lblAcctNo As Label
	Private lblAcctName As Label
	Private lblAcctAddress As Label

	'Previous Cons
	Private pnlPrevious As Panel
	Private lblClass As Label
	Private lblPrevCum As Label
	Private lblReadStatus As Label

	'Present Reading & Cons
	Private pnlPresent As Panel
	Private txtPresRdg As EditText
	Private lblPresCum As Label
	Private lblDiscon As Label

	'Findings and Remarks
	Private pnlFindings As Panel
	Private lblFindings As Label
	Private lblMissCode As Label
	Private lblWarning As Label
	Private lblRemarks As Label
	
	'Buttons
	Private pnlButtons As Panel
	Private btnPrevious As ACButton
	Private btnNext As ACButton
	Private btnEdit As ACButton
	Private btnMissCode As ACButton
	Private btnRemarks As ACButton
	Private btnReprint As ACButton

	'Status
	Private pnlStatus As Panel
	Private lblNoAccts As Label
	Private lblUnreadCount As Label
	'////////////////////////////////////////////////////////////
	
	'DataFields
	'Fixed
	Private ReadID As Int
	Private BillNo As String
	Private BookNo As Int
	Private AcctID As Int
	Private AcctNo As String
	Private AcctName As String
	Private AcctAddress As String
	Private AcctClass As String
	Private AcctSubClass As String
	Private AcctClassification As String'Classification
	Private AcctStatus As String
	Private MeterNo As String
	Private MaxReading As Double
	Private SeqNo As String
	Private IsSenior As Int
	Private SeniorOnBefore As Double
	Private SeniorAfter As Double
	Private SeniorMaxCum As Double
	Private GDeposit As Double

	Private PrevRdgDate As String
	Private PrevRdg As Int
	Private PrevCum As String
	
	Private FinalRdg As Int
	Private DisconDate As String

	Private PresRdgDate As String
	Private PresRdg As String
	Private PresCum As String

	Private DateFrom As String
	Private DateTo As String
	Private WithDueDate As Int
	Private DueDate As String
	Private DisconnectionDate As String
	Private AveCum As Double
	Private AddCons As Double
	Private TotalCum As Int
	Private BasicAmt As Double
	Private PCA As Double
	Private PCAAmt As Double
	Private AddToBillAmt As Double
	Private AdvPayment As Double
	Private PenaltyPct As Double
	Private PenaltyAmt As Double
	Private TotalDueAmtAfterSC As Double

	Private ReadRemarks As String
	Private sAveRem As String
	Private strReadRemarks As String
	Private PaidStatus As Int
	Private PrintStatus As Int
	Private WasMissCoded As Int
	Private MissCodeID As Int
	Private MissCode As String
	Private WasImplosive As Int
	Private ImplosiveType As String

	Private WasRead As Int
	Private FFindings As String
	Private FWarnings As String
	Private NewSeqNo As Int
	Private NoInput As Int
	Private TimeRead As String
	Private DateRead As String
	Private WasUploaded As Int

	'Variants
	Private BillType As String
	Private CurrentAmt As Double
	Private ArrearsAmt As Double
	Private TotalDueAmt As Double
	Private SeniorOnBeforeAmt As Double
	Private SeniorAfterAmt As Double
	Private TotalDueAmtBeforeSC As Double
	Private intRateHeaderID As Int
	Private DiscAmt, DiscAmt2 As Double
	
	Private MeterCharges As Double
	Private FranchiseTaxPct As Double
	Private FranchiseTaxAmt As Double
	Private SeptageFeeAmt As Double
	Private NoPrinted As Int
	Private BillPeriod1st As String
	Private PrevCum1st As Int
	Private BillPeriod2nd As String
	Private PrevCum2nd As Int
	Private BillPeriod3rd As String
	Private PrevCum3rd As Int
	Private HasSeptageFee As Int

	'Global Variables
	Private blnEdit As Boolean 'Edit button trigger

	Private BookMark = 0 As Int
	Private RecCount = 0 As Int
	Private CountUnReadAcct As Int
	Private intCurrPos As Int
	Private intTempCurrPos As Int

	Private flagBitmap As Bitmap
	Private ZeroConsIcon As Bitmap
	Private MissCodeIcon As Bitmap
	
	'Unusual Readings Status
	Dim badgeMissCode, badgeZero, badgeHigh, badgeLow, badgeTotal As Badger
	Dim intMissCode, intZero, intHigh, intLow, intAve, intTotal As Int

	'Search Unusual
	Private pnlUnusual As Panel
	Private intSearchFlag As Int
	Private pnlSearchUnusual As Panel
	Private lblUnusualCount As Label
	Private btnCancelUnusual As ACButton

	'Search Options
	Private pnlSearch As Panel
	Private pnlSearchOptions As Panel
	Private pnlSearchBy As Panel
	Private optUnread As RadioButton
	Private optRead As RadioButton
	Private optAll As RadioButton
	Private optSeqNo As RadioButton
	Private optMeterNo As RadioButton
	Private optAcctName As RadioButton
	Private SearchPanel As Panel
	Private SearchFor As String
	Private lblSearchRecCount As Label
	Private btnCancelSearch As ACButton
	
	'Printing
	Private BookID As Int
	Private BookSeq As String
	Private CustClass As String
	Private BillDate As String

	Private sBranchName As String
	Private sBranchAddress As String
	Private sBranchContactNo As String
	Private sTinNo As String
	Private sBranchCode As String
	Private sBillPeriod As String
	Private iHasSeptage As Int
		
	'to String
	Private sPresRdg As String
	Private sPrevRdg As String
	Private sAddCons As String
	Private sTotalCum As String

	Private sGDeposit As String
	Private sBasicAmt As String
	Private sPCAAmt As String
	Private sCurrentAmt As String
	Private sDiscAmt As String
	Private sSeniorOnBeforeAmt As String
	Private sAddToBillAmt As String
	Private sArrearsAmt As String
	Private sAdvPayment As String
	Private sTotalDueAmt As String
	Private sPenaltyAmt As String
	Private sSeniorAfterAmt As String
	Private sTotalDueAmtAfterSC As String

	Private sMeterCharges As Double
	Private sFranchiseTaxAmt As Double
	Private sSeptageFeeAmt As Double

	Private vibration As B4Avibrate
	Private vibratePattern() As Long
	
	Private sBillMonth As String
	Private sBillYear As String
	
	Private PresAveRdg As String
	Private PresAveCum As String
	
	Private MaxSeptageCum As Double
	Private sPresentReading As String
End Sub

Sub Activity_Create(FirstTime As Boolean)
	Scale.SetRate(0.5)
	Activity.LoadLayout("mreading2")
	BookCode = DBaseFunctions.GetCodebyID("BookCode", "tblBooks","BookID", GlobalVar.BookID)
	BookDesc = DBaseFunctions.GetCodebyID("BookDesc", "tblBooks","BookID", GlobalVar.BookID)
	
	GlobalVar.CSTitle.Initialize.Size(17).Bold.Append($"BOOK - "$ & BookCode).PopAll
	GlobalVar.CSSubTitle.Initialize.Size(14).Append(BookDesc).PopAll
	
	ToolBar.InitMenuListener
	ToolBar.Title = GlobalVar.CSTitle
	ToolBar.SubTitle = GlobalVar.CSSubTitle
	ToolBar.SetElevationAnimated(5,5dip)
	
	Dim jo As JavaObject
	Dim xl As XmlLayoutBuilder
	jo = ToolBar
	jo.RunMethod("setPopupTheme", Array(xl.GetResourceId("style", "ToolbarMenu")))
	jo.RunMethod("setContentInsetStartWithNavigation", Array(1dip))
	jo.RunMethod("setTitleMarginStart", Array(0dip))
	
	ActionBarButton.Initialize
	ActionBarButton.ShowUpIndicator = True

	txtPresRdg.Color = Colors.Black
	txtPresRdg.TextColor = 0xFFFFDB71

	SetButtonColors
	ClearDisplay
	If RetrieveRecords(GlobalVar.BookID) = True Then
		rsLoadedBook.Position = 0
		DisplayRecord
		ButtonState
	End If

	If FirstTime Then
		flagBitmap = LoadBitmap(File.DirAssets, "flag.png")
	End If
	
	pnlSearch.Visible = False
	pnlUnusual.Visible = False
	BTAdmin.Initialize("Admin")
	Serial1.Initialize("Printer")
End Sub


Sub Activity_KeyPress (KeyCode As Int) As Boolean 'Return True to consume the event
	If KeyCode = 4 Then
		ToolBar_NavigationItemClick
		Return True
	Else
		Return False
	End If
End Sub

Sub Activity_Resume
	SetButtonColors
	pnlSearch.Visible=False
	pnlUnusual.Visible = False
	BTAdmin.Initialize("Admin")
	Serial1.Initialize("Printer")
	vibratePattern = Array As Long(500, 500, 300, 500)
	IMEkeyboard.SetLengthFilter(txtPresRdg, 10)

	sBillYear = GlobalVar.BillYear
	If GlobalVar.SF.Len(GlobalVar.BillMonth) = 1 Then
		sBillMonth = "0" & GlobalVar.BillMonth
	Else
		sBillMonth = GlobalVar.BillMonth
	End If
End Sub

Sub Activity_Pause (UserClosed As Boolean)
End Sub

Sub Activity_PermissionResult (Permission As String, Result As Boolean)
	If Permission = Permissions.PERMISSION_CAMERA Then
		LogColor("YOU CAN USE THE CAMERA",Colors.Red)
		snack.Initialize("",Activity, $"Camera is ready to use..."$, snack.DURATION_SHORT)
		SetSnackBarBackground(snack, GlobalVar.PriColor)
		SetSnackBarTextColor(snack, Colors.White)
		snack.Show
	End If
	Log("Permissions OK")

End Sub

#Region MainMenu
Sub Activity_CreateMenu(Menu As ACMenu)
	Dim iItem As ACMenuItem

	Menu.Clear
	Menu.Add2(1, 1, $"Search"$, xmlIcon.GetDrawable("ic_find_in_page_white_36dp")).ShowAsAction = iItem.SHOW_AS_ACTION_ALWAYS
	Menu.Add2(2, 2, "Flag", xmlIcon.GetDrawable("ic_flag_white_24dp")).ShowAsAction = iItem.SHOW_AS_ACTION_ALWAYS
	Menu.Add2(3, 3, "SubMenu", xmlIcon.GetDrawable("ic_menu_white_24dp")).ShowAsAction = iItem.SHOW_AS_ACTION_IF_ROOM
	
	flagBitmap = LoadBitmap(File.DirAssets, "flag.png")
	
	If GetUnusualCount(GlobalVar.BookID) = True Then
		UpdateBadge("Flag", AddBadgeToIcon(flagBitmap, intTotal))
	End If
	CreateSubMenus
End Sub

Private Sub CreateSubMenus
	PopWarnings.Initialize("PopWarning", ToolBar.GetView(3))
	PopSubMenu.Initialize("PopSubMnu", ToolBar.GetView(3))
			
	Dim csMissCode, csZero, csHigh, csLow As CSBuilder
	
	csMissCode.Initialize.Bold.Size(16).Color(GlobalVar.PriColor).Append("Miss Coded").PopAll
	csZero.Initialize.Bold.Size(16).Color(GlobalVar.PriColor).Append("Zero Cons").PopAll
	csHigh.Initialize.Bold.Size(16).Color(GlobalVar.PriColor).Append("High Bill").PopAll
	csLow.Initialize.Bold.Size(16).Color(GlobalVar.PriColor).Append("Low Bill").PopAll
	
	PopWarnings.AddMenuItem(101, "Miss Coded", xmlIcon.GetDrawable("ic_timer_off_black_24dp"))
	PopWarnings.AddMenuItem(102, "Zero Cons", xmlIcon.GetDrawable("ic_exposure_zero_black_24dp"))
	PopWarnings.AddMenuItem(103, "High Bill", xmlIcon.GetDrawable("ic_trending_up_black_24dp"))
	PopWarnings.AddMenuItem(104, "Low Bill", xmlIcon.GetDrawable("ic_trending_down_black_24dp"))
	PopWarnings.AddMenuItem(105, "Average Bill", xmlIcon.GetDrawable("ic_timeline_black_24dp"))

	PopSubMenu.AddMenuItem(202, "Average Bill",xmlIcon.GetDrawable("ic_timeline_black_24dp"))
	PopSubMenu.AddMenuItem(201, "Take Photo",xmlIcon.GetDrawable("ic_add_a_photo_black_24dp"))
	PopSubMenu.AddMenuItem(203, "Cancel Reading",xmlIcon.GetDrawable("ic_visibility_off_black_24dp"))
End Sub

Sub AddBadgeToIcon(bmp As Bitmap, Number As Int) As Bitmap
	Dim cvs As Canvas
	Dim mbmp As Bitmap
	mbmp.InitializeMutable(32dip, 32dip)
	cvs.Initialize2(mbmp)
	Dim target As Rect
	target.Initialize(0, 0, mbmp.Width, mbmp.Height)
	cvs.DrawBitmap(bmp, Null, target)

	If Number > 0 Then
		cvs.DrawCircle(mbmp.Width - 8dip, 8dip, 8dip, Colors.Red, True, 0)
		cvs.DrawText(Min(Number, 100), mbmp.Width - 8dip, 12dip, Typeface.DEFAULT_BOLD, 12, Colors.White, "CENTER")
	End If
	Return mbmp
End Sub

Sub UpdateBadge(MenuTitle As String, Icon As Bitmap)
	Dim m As ACMenuItem = GetMenuItem(MenuTitle)
	m.Icon = BitmapToBitmapDrawable(Icon)
End Sub

Sub BitmapToBitmapDrawable (bitmap As Bitmap) As BitmapDrawable
	Dim bd As BitmapDrawable
	bd.Initialize(bitmap)
	Return bd
End Sub

Sub GetMenuItem(Title As String) As ACMenuItem
	For i = 0 To ToolBar.Menu.Size - 1
		Dim m As ACMenuItem = ToolBar.Menu.GetItem(i)
		If m.Title = Title Then
			Return m
		End If
	Next
	Return Null
End Sub

Sub ToolBar_NavigationItemClick
	If pnlSearch.Visible = True Then
		btnCancelSearch_Click
		IMEkeyboard.HideKeyboard
	Else If pnlUnusual.Visible = True Then
		btnCancelUnusual_Click
		IMEkeyboard.HideKeyboard
	Else If blnEdit = True And txtPresRdg.Enabled = True Then
		rsLoadedBook.Position = intCurrPos
		DisplayRecord
		ButtonState
	Else
		IMEkeyboard.HideKeyboard
		Activity.Finish
	End If
End Sub

Sub ToolBar_MenuItemClick (Item As ACMenuItem)
	Select Item.Id
		Case 1
			If pnlSearch.Visible=True Then Return
			intTempCurrPos = rsLoadedBook.Position
			DisableControls
			SV.Initialize(Me,"SV")
			SV.AddToParent(SearchPanel,10,30,SearchPanel.Width,SearchPanel.Height)
			SV.ClearAll

			pnlSearch.Visible=True
			optUnread.Checked = True
			optSeqNo.Checked=True
			optSeqNo_CheckedChange(True)
		Case 2
			PopWarnings.Show
		Case 3
			PopSubMenu.Show
	End Select
End Sub

Sub PopWarning_ItemClicked (Item As ACMenuItem)
	Log("Popupmenu Item clicked: " & Item.Id & " - " & Item.Title)

	ToolBar.Menu.FindItem(1).Enabled = False
	ToolBar.Menu.FindItem(2).Enabled = False
	ToolBar.Menu.FindItem(3).Enabled = False

	Select Case Item.Id
		Case 101'Misscode
			intSearchFlag = 0
		
		Case 102'Zero
			intSearchFlag = 1
		
		Case 103'High Bill
			intSearchFlag = 2
		
		Case 104 'Low bill
			intSearchFlag = 3

		Case 105 'Average Bill
			intSearchFlag = 4
	End Select

	If pnlUnusual.Visible = True Then Return
	DisableControls
	pnlUnusual.Visible = True
	SV.Initialize(Me,"SV")
	SV.AddToParent(pnlSearchUnusual,10,30,pnlSearchUnusual.Width,pnlSearchUnusual.Height)
	SV.ClearAll
	SearchUnsualReading(intSearchFlag)
	
End Sub

Sub PopSubMnu_ItemClicked (Item As ACMenuItem)
	Dim sFileName As String
	GlobalVar.strBookSequence = BookNo & "-" & SeqNo

	Select Case Item.Id
		Case 201'Camera
			GlobalVar.isAverage = 0
			Log(GlobalVar.strBookSequence)
			Permissions.CheckAndRequest(Permissions.PERMISSION_CAMERA)
			StartActivity(NewCam)
		Case 202'Average
'			snack.Initialize("", Activity, $"SORRY Features not yet Available"$, snack.DURATION_SHORT)
'			SetSnackBarBackground(snack, Colors.Red)
'			SetSnackBarTextColor(snack, Colors.White)
'			snack.Show
			intTempCurrPos = rsLoadedBook.Position
			If WasRead = 1 Then
				If WasMissCoded = 1 Then
					blnEdit = True
				Else
					ShowAveNotAvailableDialog
					Return
				End If
			End If

			sFileName = sBillYear & "-" & sBillMonth & "-" & GlobalVar.strBookSequence & ".jpg"
			If File.Exists(File.DirRootExternal, sFileName) = False Then
				ShowFileNotFoundDialog
				Return
			End If
			ShowAverageBillRemarks
			
		Case 203'Cancel
			rsLoadedBook.Position = intCurrPos
			DisplayRecord
			ButtonState
	End Select
	
End Sub

Sub FindViewByTag(Parent As Panel, Name As String) As View
	For Each v As View In Parent.GetAllViewsRecursive
		If Name = v.Tag Then Return v
	Next
	Log("View not found: " & Name)
	Return Null
End Sub


#End Region

#Region UI Display
Sub DisplayRecord()
	'Variables to hold current record
	ReadID = rsLoadedBook.GetInt("ReadID")
	BillNo = rsLoadedBook.GetString("BillNo")
	AcctID = rsLoadedBook.GetInt("AcctID")
	AcctNo = rsLoadedBook.GetString("AcctNo")
	AcctName = rsLoadedBook.GetString("AcctName")
	AcctAddress = rsLoadedBook.GetString("AcctAddress")
	AcctClass = rsLoadedBook.GetString("AcctClass")
	AcctSubClass = rsLoadedBook.GetString("AcctSubClass")
	AcctStatus = rsLoadedBook.GetString("AcctStatus")
	MeterNo = rsLoadedBook.GetString("MeterNo")
	MaxReading = rsLoadedBook.GetDouble("MaxReading")
	BookNo = rsLoadedBook.GetString("BookNo")
	SeqNo = rsLoadedBook.GetString("SeqNo")
	IsSenior = rsLoadedBook.GetInt("IsSenior")
	SeniorOnBefore = rsLoadedBook.GetDouble("SeniorOnBefore")
	SeniorAfter = rsLoadedBook.GetDouble("SeniorAfter")
	SeniorMaxCum = rsLoadedBook.GetDouble("SeniorMaxCum")
	GDeposit = rsLoadedBook.GetDouble("GDeposit")
	PrevRdgDate = rsLoadedBook.GetString("PrevRdgDate")
	PrevRdg = rsLoadedBook.GetInt("PrevRdg")
	PrevCum = rsLoadedBook.GetInt("PrevCum")
	FinalRdg = rsLoadedBook.GetInt("FinalRdg")
	GlobalVar.CamAcctNo = AcctNo
	GlobalVar.CamMeterNo = MeterNo
	Log(PrevRdg & " - " & PrevCum)
	
	PresRdgDate = rsLoadedBook.GetString("PresRdgDate")
	PresRdg = rsLoadedBook.GetString("PresRdg")
	PresCum = rsLoadedBook.GetInt("PresCum")
	DateFrom = rsLoadedBook.GetString("DateFrom")
	DateTo = rsLoadedBook.GetString("DateTo")
	DueDate = rsLoadedBook.GetString("DueDate")
	AveCum = rsLoadedBook.GetLong("AveCum")
	BillType = rsLoadedBook.GetString("BillType")
	AddCons = rsLoadedBook.GetDouble("AddCons")
	TotalCum = rsLoadedBook.GetInt("TotalCum")
	BasicAmt = rsLoadedBook.GetDouble("BasicAmt")
	PCA = rsLoadedBook.GetDouble("PCA")
	AddToBillAmt = rsLoadedBook.GetDouble("AddToBillAmt")
	ArrearsAmt = rsLoadedBook.GetDouble("ArrearsAmt")
	AdvPayment = rsLoadedBook.GetDouble("AdvPayment")
	PenaltyPct = rsLoadedBook.GetDouble("PenaltyPct")
	PenaltyAmt = rsLoadedBook.GetDouble("PenaltyAmt")

	WasRead = rsLoadedBook.GetInt("WasRead")
	WasMissCoded = rsLoadedBook.GetInt("WasMissCoded")
	MissCodeID = rsLoadedBook.GetInt("MissCodeID")
	MissCode = rsLoadedBook.GetString("MissCode")
	WasImplosive = rsLoadedBook.GetInt("WasImplosive")
	ImplosiveType = rsLoadedBook.GetString("ImplosiveType")

	FFindings = rsLoadedBook.GetString("FFindings")
	FWarnings = rsLoadedBook.GetString("FWarnings")
	ReadRemarks = rsLoadedBook.GetString("ReadRemarks")
	NoInput = rsLoadedBook.GetInt("NoInput")
	WasUploaded = rsLoadedBook.GetInt("WasUploaded")
	PrintStatus = rsLoadedBook.GetInt("PrintStatus")

	MeterCharges = rsLoadedBook.GetDouble("MeterCharges")
	FranchiseTaxPct = rsLoadedBook.GetDouble("FranchiseTaxPct")
'	FranchiseTaxAmt = rsLoadedBook.GetDouble("FranchiseTaxAmt")
	SeptageFeeAmt = rsLoadedBook.GetDouble("SeptageAmt")
	NoPrinted = rsLoadedBook.GetInt("NoPrinted")
	PrevCum1st = rsLoadedBook.GetInt("PrevCum1st")
	PrevCum2nd = rsLoadedBook.GetInt("PrevCum2nd")
	PrevCum3rd = rsLoadedBook.GetInt("PrevCum3rd")
	HasSeptageFee = rsLoadedBook.GetInt("HasSeptageFee")
	WithDueDate = rsLoadedBook.GetInt("WithDueDate")
	MaxSeptageCum = rsLoadedBook.GetInt("MaxSeptageCum")

	AcctClassification = AcctClass & "-" & AcctSubClass
	strReadRemarks = ""
	'UI Display
'	lblSeqNo.Text = SeqNo
	If GlobalVar.SF.Len(SeqNo) = 1 Then
		lblSeqNo.Text = $"000"$ & SeqNo
	Else If GlobalVar.SF.Len(SeqNo) = 2 Then
		lblSeqNo.Text = $"00"$ & SeqNo
	Else If GlobalVar.SF.Len(SeqNo) = 3 Then
		lblSeqNo.Text = $"0"$ & SeqNo
	Else If GlobalVar.SF.Len(SeqNo) >= 4 Then
		lblSeqNo.Text = SeqNo
	End If
	
	lblMeter.Text = MeterNo
	lblAcctNo.Text = AcctNo
	lblAcctName.Text = GlobalVar.SF.Upper(AcctName)
	lblAcctAddress.Text = GlobalVar.SF.Proper(AcctAddress)
	lblClass.Text = AcctClassification
	lblPrevCum.Text = PrevCum

	lblFindings.Text = FFindings
	lblMissCode.Text = MissCode
	lblWarning.Text = FWarnings

	Log(PresRdg)

	If WasRead = 0 And (PresRdg = Null Or PresRdg = "") Then
		btnEdit.Enabled = False
		btnRemarks.Enabled = False
		btnReprint.Enabled = False
		lblPresCum.Text = ""
		txtPresRdg.Text = ""
		txtPresRdg.Enabled = True
		txtPresRdg.RequestFocus
		IMEkeyboard.SetCustomFilter(txtPresRdg, txtPresRdg.INPUT_TYPE_NUMBERS,"1234567890")
		IMEkeyboard.ShowKeyboard(txtPresRdg)
		lblReadStatus.Text = "UNREAD"
		lblReadStatus.TextColor = Colors.Red
	Else If WasRead = 1 And WasMissCoded = 1 Then
		lblReadStatus.Text = "READ"
		lblReadStatus.TextColor = 0xFF14C0DB
		btnEdit.Enabled = True
		btnReprint.Enabled = False
		btnRemarks.Enabled = True
		txtPresRdg.Text = PresRdg
		txtPresRdg.Enabled = False
		lblPresCum.Text = PresCum
		IMEkeyboard.HideKeyboard
	Else
		lblReadStatus.Text = "READ"
		lblReadStatus.TextColor = 0xFF14C0DB
		btnEdit.Enabled = True
		btnReprint.Enabled = True
		btnRemarks.Enabled = True
		txtPresRdg.Text = PresRdg
'		txtPresRdg.Enabled = True
		txtPresRdg.Enabled = False
		lblPresCum.Text = PresCum
		IMEkeyboard.HideKeyboard
	End If
	
	If WasMissCoded = 1 Then
		lblMissCode.Text = MissCode
		lblMissCode.TextColor = Colors.Red
		lblFindings.TextColor = Colors.Red
	Else
		lblMissCode.Text = "N/A"
		lblMissCode.TextColor = 0xFF3A3A3A
		lblFindings.TextColor = 0xFF3A3A3A
	End If
	
	If FFindings.Length > 0 Then
		lblFindings.Text = FFindings
	Else
		lblFindings.Text = "Actual Reading"
	End If

	If FWarnings.Length > 0  Then
		If FWarnings<>"NONE" Then
			lblWarning.Text = FWarnings
			lblWarning.TextColor = Colors.Red
		Else
			lblWarning.TextColor = 0xFF3A3A3A
		End If
	Else
		lblWarning.Text = "N/A"
		lblWarning.TextColor = 0xFF3A3A3A
	End If

	If ReadRemarks.Length > 0 Then
		lblRemarks.Text = ReadRemarks
	Else
		lblRemarks.Text = "N/A"
	End If

	'//////////////////////////////////////////////////////////////////////////////////////////////////////
	If AcctStatus = "dc" Then
		txtPresRdg.Text = FinalRdg
		txtPresRdg.Enabled = False
		txtPresRdg.RequestFocus
		txtPresRdg.SelectionStart=0
		txtPresRdg.SelectAll
		IMEkeyboard.ShowKeyboard(txtPresRdg)
		lblDiscon.Visible = True
	Else
		lblDiscon.Visible = False
	End If
	'//////////////////////////////////////////////////////////////////////////////////////////////////////

	intCurrPos = rsLoadedBook.Position
	BookMark = rsLoadedBook.Position + 1
	CountUnReadAcct = CountUnread(GlobalVar.BookID)
	
	lblNoAccts.Text = $"Record "$ & BookMark & $" of "$ & RecCount
	lblUnreadCount.Text = $"Unread Acct(s). : "$ & CountUnReadAcct
End Sub

Sub ClearDisplay
	lblSeqNo.Text = ""
	lblMeter.Text = ""
	lblAcctNo.Text = ""
	lblAcctName.Text = ""
	lblAcctAddress.Text = ""
	lblClass.Text = ""
	lblPrevCum.Text = ""
	lblFindings.Text = ""
	lblMissCode.Text = ""
	lblWarning.Text = ""

	BookMark = 0
'	pnlSearch.Visible=False
	
	btnPrevious.Enabled=False
	btnNext.Enabled=False
	btnMissCode.Enabled=False
	btnRemarks.Enabled=False
	btnEdit.Enabled=False
	btnReprint.Enabled=False
	btnReprint.Text = "Print"
End Sub
Public Sub CreateButtonColor(FocusedColor As Int, EnabledColor As Int, DisabledColor As Int, PressedColor As Int) As StateListDrawable

	Dim RetColor As StateListDrawable
	RetColor.Initialize
	Dim drwFocusedColor, drwEnabledColor, drwDisabledColor, drwPressedColor As ColorDrawable

	'drwFocusedColor.Initialize2(FocusedColor, 5, 0, Colors.LightGray) 'border roundness, thickness, and color on Android TV
	'drwEnabledColor.Initialize2(EnabledColor, 5, 0, Colors.DarkGray)
	'drwDisabledColor.Initialize2(DisabledColor, 5, 0, Colors.White)
	'drwPressedColor.Initialize2(PressedColor, 5, 0, Colors.Black)
'	CD.Initialize(0xFF1976D2, 25)
	
	drwFocusedColor.Initialize2(FocusedColor, 25, 0, Colors.Black)
	drwEnabledColor.Initialize2(EnabledColor, 25, 0, Colors.Black)
	drwDisabledColor.Initialize2(DisabledColor, 25, 2, Colors.Black)
	drwPressedColor.Initialize2(PressedColor, 25, 0, Colors.Black)

	RetColor.AddState(RetColor.State_Focused, drwFocusedColor)
	RetColor.AddState(RetColor.State_Pressed, drwPressedColor)
	RetColor.AddState(RetColor.State_Enabled, drwEnabledColor)
	RetColor.AddState(RetColor.State_Disabled, drwDisabledColor)
	RetColor.AddCatchAllState(drwFocusedColor)
	RetColor.AddCatchAllState(drwEnabledColor)
	RetColor.AddCatchAllState(drwDisabledColor)
	RetColor.AddCatchAllState(drwPressedColor)
	Return RetColor

End Sub

Private Sub SetButtonColors()
	btnPrevious.Background = CreateButtonColor(0xFF0D47A1, 0xFF0D47A1,0xFF1E88E5, 0xFF0D47A1)
	btnNext.Background = CreateButtonColor(0xFF0D47A1, 0xFF0D47A1,0xFF1E88E5, 0xFF0D47A1)
	btnEdit.Background = CreateButtonColor(0xFF0D47A1, 0xFF0D47A1,0xFF1E88E5, 0xFF0D47A1)
	btnMissCode.Background = CreateButtonColor(0xFF0D47A1, 0xFF0D47A1,0xFF1E88E5, 0xFF0D47A1)
	btnRemarks.Background = CreateButtonColor(0xFF0D47A1, 0xFF0D47A1,0xFF1E88E5, 0xFF0D47A1)
	btnReprint.Background = CreateButtonColor(0xFF0D47A1, 0xFF0D47A1,0xFF1E88E5, 0xFF0D47A1)
	btnCancelSearch.Background = CreateButtonColor(0xFF0D47A1, 0xFF0D47A1,0xFF1E88E5, 0xFF0D47A1)
	btnCancelUnusual.Background = CreateButtonColor(0xFF0D47A1, 0xFF0D47A1,0xFF1E88E5, 0xFF0D47A1)
End Sub

Sub DisableControls
	pnlMain.Enabled = False
	ToolBar.Enabled = False
	pnlAccountInfo.Enabled = False
	pnlPrevious.Enabled = False
	pnlPresent.Enabled = False
	pnlFindings.Enabled = False
	pnlButtons.Enabled = False
	pnlStatus.Enabled = False
	
	txtPresRdg.Enabled = False
	btnPrevious.Enabled = False
	btnNext.Enabled = False
	btnEdit.Enabled = False
	btnMissCode.Enabled = False
	btnRemarks.Enabled = False
	btnReprint.Enabled = False

	ToolBar.Menu.FindItem(1).Enabled = False
	ToolBar.Menu.FindItem(2).Enabled = False
	ToolBar.Menu.FindItem(3).Enabled = False
End Sub

Sub EnableControls
	pnlMain.Enabled = True
	ToolBar.Enabled = True
	pnlAccountInfo.Enabled = True
	pnlPrevious.Enabled = True
	pnlPresent.Enabled = True
	pnlFindings.Enabled = True
	pnlButtons.Enabled = True
	pnlStatus.Enabled = True

	ToolBar.Menu.FindItem(1).Enabled = True
	ToolBar.Menu.FindItem(2).Enabled = True
	ToolBar.Menu.FindItem(3).Enabled = True
End Sub

Sub ButtonState
	If RecCount > 0 Then
		If rsLoadedBook.Position <= 0 Then
			btnPrevious.Enabled=False
			btnNext.Enabled=True
		Else if rsLoadedBook.Position = RecCount - 1 Then
			btnPrevious.Enabled=True
			btnNext.Enabled=False
		Else
			btnPrevious.Enabled=True
			btnNext.Enabled=True
		End If
	Else
		ClearDisplay
		Return
	End If
	
	If WasRead = 1 Then
		If WasMissCoded = 1 Then
			btnMissCode.Text="CHANGE MISSCODE"
			btnMissCode.Enabled = True
			btnReprint.Enabled = False
			btnReprint.Text = "Print"
			btnEdit.Enabled = True
		Else
			btnMissCode.Enabled = False
			btnMissCode.Text="ADD MISSCODE"
			btnMissCode.Enabled = False
			btnReprint.Enabled = True
			If PrintStatus = 1 Then
				btnReprint.Text = "Reprint"
				btnEdit.Enabled = False
			Else
				btnReprint.Text = "Print"
				btnEdit.Enabled = True
			End If
		End If
		
		btnRemarks.Enabled = True
		If ReadRemarks = Null Or ReadRemarks.Length <= 0 Then
			btnRemarks.Text="ADD REMARKS"
		Else
			btnRemarks.Text="CHANGE REMARKS"
		End If
	Else
		If AcctStatus = "dc" Then
			btnMissCode.Enabled = False
			IMEkeyboard.ShowKeyboard(txtPresRdg)
		Else
			btnRemarks.Text = "ADD REMARKS"
			btnMissCode.Text = "ADD MISSCODE"
			btnMissCode.Enabled = True
			btnEdit.Enabled = False
			btnRemarks.Enabled = False
			btnReprint.Text = "Print"
			btnReprint.Enabled = False
		End If
	End If
	
	If WasUploaded = 1 Then
		btnEdit.Enabled = False
		btnMissCode.Enabled = False
		btnRemarks.Enabled = False
		btnReprint.Enabled = True
	Else
'		btnEdit.Enabled = True
		btnMissCode.Enabled = True
'		btnRemarks.Enabled = True
	End If
	
	If WasRead = 1 And WasMissCoded = 0 Then
		btnMissCode.Enabled = False
	End If
'	If WasMissCoded = 1 Then
'		btnMissCode.Text="CHANGE MISSCODE"
'		btnMissCode.Enabled = True
'		btnReprint.Enabled = False
'	Else If WasRead = 1 And PresRdg <> "" Then
'		btnMissCode.Enabled = False
'		btnMissCode.Text="ADD MISSCODE"
'		btnReprint.Enabled = False
'	Else
'		btnMissCode.Text = "ADD MISSCODE"
'		btnMissCode.Enabled = True
'		btnReprint.Enabled = True
'	End If
	
'	If WasRead = 0 Then
'	Else
'		btnReprint.Enabled = True
'		If PrintStatus = 1 Then
'			btnReprint.Text = "RePrint"
'		Else
'			btnReprint.Text="Print"
'		End If
'		If WasUploaded = 1 Then
'		End If
'	End If
End Sub
#End Region

#Region DataBase
Sub RetrieveRecords(iBookID As Int) As Boolean
	Dim blnRet As Boolean
	Try
		Starter.strCriteria="SELECT * FROM tblReadings " & _
							"WHERE BookID=" & iBookID & " AND BillYear= " & GlobalVar.BillYear & " AND BillMonth=" & GlobalVar.BillMonth & " ORDER BY (case when tblReadings.NewSeqNo is null THEN tblReadings.SeqNo else tblReadings.NewSeqNo end), SeqNo ASC, TimeRead ASC, DateRead ASC, AcctID"
		Log(Starter.strCriteria)
		rsLoadedBook=Starter.DBCon.ExecQuery(Starter.strCriteria)
		If rsLoadedBook.RowCount>0 Then
			RecCount=rsLoadedBook.RowCount
			blnRet= True
		Else
			blnRet=False
		End If
	Catch
		blnRet=False
		Log(LastException)
		ToastMessageShow("Unable to retreive records due to " & LastException.Message & "!",False)
	End Try
	Return blnRet
End Sub
Private Sub CountUnread(iBookID As Int) As Int
	Dim iCount As Int
	Try
		Starter.strCriteria="SELECT SUM(CASE WHEN tblReadings.WasRead = 0 Then 1 Else 0 End) As UnreadAccts FROM tblReadings " & _
							"WHERE BookID=" & iBookID & " AND BillYear= " & GlobalVar.BillYear & " AND BillMonth=" & GlobalVar.BillMonth
		Log(Starter.strCriteria)

		iCount = Starter.DBCon.ExecQuerySingleResult(Starter.strCriteria)
		Log(iCount)
	Catch
		iCount = 0
		ToastMessageShow("Unable to COUNT unread Account(s) due to " & LastException.Message, False)
		Log(LastException.Message)
	End Try

	Return iCount
End Sub

Private Sub GetUnusualCount(iBookID As Int) As Boolean
	Dim blnRetVal As Boolean
	Try
		Starter.strCriteria = "SELECT SUM(CASE WHEN WasMissCoded = 1 THEN 1 ELSE 0 END) as MissCoded, " & _
							  "SUM(CASE WHEN ImplosiveType = 'zero' Then 1 ELSE 0 END) As ZeroCons, " & _
							  "SUM(CASE WHEN ImplosiveType = 'implosive-inc' Then 1 ELSE 0 END) As HighBill, " & _
							  "SUM(CASE WHEN ImplosiveType = 'implosive-dec' Then 1 ELSE 0 END) As LowBill, " & _
							  "SUM(CASE WHEN BillType = 'AB' Then 1 ELSE 0 END) As AveBill " & _
							  "FROM tblReadings " & _
							  "WHERE BookID = " & iBookID & " " & _
							  "AND BillYear = " & GlobalVar.BillYear & " " & _
							  "AND BillMonth = " & GlobalVar.BillMonth
		rsUnusualReading = Starter.DBCon.ExecQuery(Starter.strCriteria)
		If rsUnusualReading.RowCount > 0 Then
			rsUnusualReading.Position = 0
			blnRetVal = True
			intMissCode = rsUnusualReading.GetInt("MissCoded")
			intZero = rsUnusualReading.GetInt("ZeroCons")
			intHigh = rsUnusualReading.GetInt("HighBill")
			intLow = rsUnusualReading.GetInt("LowBill")
			intAve = rsUnusualReading.GetInt("AveBill")
			intTotal = intMissCode + intZero + intHigh + intLow + intAve
		Else
			blnRetVal = False
		End If
		rsUnusualReading.Close
		Return blnRetVal
	Catch
		blnRetVal = False
		Log(LastException)
	End Try
End Sub
#End Region

#Region Present Reading
Sub txtPresRdg_TextChanged (Old As String, New As String)
	If strSF.Len(txtPresRdg.Text.Trim) <= 0 Then
		lblPresCum.Text = ""
		Return
	End If
	lblPresCum.Text = ComputeCumUsed

'	If Old = New Then
'		WasEdited = False
'	Else
'		WasEdited = True
'	End If
End Sub

Sub txtPresRdg_EnterPressed
	Dim Currcum As Double
	
	intCurrPos = rsLoadedBook.Position
	Currcum = 0
	Currcum = strSF.Val(txtPresRdg.Text) - PrevRdg
	
	If blnEdit = False Then ' New Readings
		If strSF.Len(txtPresRdg.Text.Trim) <= 0 Or IsNumber(txtPresRdg.Text) = False Then Return
		
		If strSF.Val(lblPresCum.Text) < 0 Or strSF.Val(txtPresRdg.Text) < PrevRdg Then 'Negative Consumption
			vibration.vibratePattern(vibratePattern, 0)
			WasImplosive = 1
			ShowNegativeReadingDialog
		Else If strSF.Val(lblPresCum.Text) = 0 Or strSF.Val(txtPresRdg.Text) = PrevRdg Then 'Zero Consumption
			vibration.vibratePattern(vibratePattern, 0)
			WasImplosive = 1
			ShowSaveZeroReadingDialog
		Else If (strSF.Val(lblPresCum.Text) - PrevCum) >= 20 Then 'High Bill
			If DBaseFunctions.IsWithinRange(Currcum, GlobalVar.BranchID, AcctClass, AcctSubClass, GlobalVar.BillYear & "-" & GlobalVar.BillMonth & "-01") = False Then
				vibration.vibratePattern(vibratePattern, 0)
				If  DispErrorMsg($"Inputted Reading Out of Range!"$, $"ERROR INPUT"$) = True Then
					vibration.vibrateCancel
					txtPresRdg.SelectionStart = 1
					txtPresRdg.SelectAll
					IMEkeyboard.ShowKeyboard(txtPresRdg)
				End If
				Return
			End If
			vibration.vibratePattern(vibratePattern, 0)
			WasImplosive = 1
			ShowHighBillDialog
		Else If (PrevCum - strSF.Val(lblPresCum.Text)) >= 20 Then 'Low Bill
			vibration.vibratePattern(vibratePattern, 0)
			WasImplosive = 1
			ShowLowBillDialog
		Else 'Normal Reading
			WasImplosive = 0
			ShowAddNewReading
		End If
		
	Else 'Edit Reading
		If strSF.Len(txtPresRdg.Text.Trim) <= 0 Or IsNumber(txtPresRdg.Text) = False Then Return
		If strSF.Val(lblPresCum.Text) < 0 Or strSF.Val(txtPresRdg.Text) < PrevRdg Then 'Negative Consumption
			vibration.vibratePattern(vibratePattern, 0)
			WasImplosive = 1
			ShowNegativeReadingDialog
		Else If strSF.Val(lblPresCum.Text) = 0 Or strSF.Val(txtPresRdg.Text) = PrevRdg Then 'Zero Consumption
			vibration.vibratePattern(vibratePattern, 0)
			WasImplosive = 1
			ShowSaveZeroReadingDialog
		Else If (strSF.Val(lblPresCum.Text) - PrevCum) >= 20 Then 'High Bill
			If DBaseFunctions.IsWithinRange(Currcum, GlobalVar.BranchID, AcctClass, AcctSubClass, GlobalVar.BillYear & "-" & GlobalVar.BillMonth & "-01") = False Then
				vibration.vibratePattern(vibratePattern, 0)
				If  DispErrorMsg($"Inputted Reading Out of Range!"$, $"ERROR INPUT"$) = True Then
					vibration.vibrateCancel
					txtPresRdg.SelectionStart = 1
					txtPresRdg.SelectAll
					IMEkeyboard.ShowKeyboard(txtPresRdg)
				End If
				Return
			End If
			vibration.vibratePattern(vibratePattern, 0)
			WasImplosive = 1
			ShowHighBillDialog
		Else If (PrevCum - strSF.Val(lblPresCum.Text)) >= 20 Then 'Low Bill
			vibration.vibratePattern(vibratePattern, 0)
			WasImplosive = 1
			ShowLowBillDialog
		Else 'Normal Reading
			WasImplosive = 0
			ShowAddNewReading
		End If
	End If
End Sub

Sub txtPresRdg_FocusChanged (HasFocus As Boolean)
	If HasFocus = True Then
		WasEdited = False
	End If
End Sub
#End Region

#Region Button Actions
Sub btnReprint_Click
'	Dim intResponse As Int
'	intResponse =Msgbox2($"Reprint Bill Statement for this Account?"$, Application.LabelName, "Yes", "", "No", Null)
'	If intResponse = DialogResponse.POSITIVE Then
'		PrintBillData(ReadID)
'	End If
	If IsPrintableData(ReadID) = False Then
		snack.Initialize("", Activity,$"No data to Reprint!"$, snack.DURATION_LONG)
		SetSnackBarBackground(snack, Colors.Red)
		SetSnackBarTextColor(snack, Colors.White)
		snack.Show
		Return
	End If

	vibration.vibrateOnce(1000)
	If PrintStatus = 1 Then
		snack.Initialize("BillReprint", Activity, $"Reprint Bill Statement for this Account?"$, snack.DURATION_LONG)
		SetSnackBarTextColor(snack, Colors.Red)
		SetSnackBarBackground(snack, Colors.White)
		snack.SetAction("YES")
		snack.Show
	Else
		snack.Initialize("BillReprint", Activity, $"Print Bill Statement for this Account?"$, snack.DURATION_LONG)
		SetSnackBarTextColor(snack, Colors.Red)
		SetSnackBarBackground(snack, Colors.White)
		snack.SetAction("YES")
		snack.Show
	End If
End Sub

Private Sub BillReprint_Click()
	ProgressDialogShow2($"Bill Statement Printing..."$, False)
	UpdatePrintStatus(ReadID, AcctID)
	PrintBillData(ReadID)
	If RetrieveRecords(GlobalVar.BookID) = True Then
		rsLoadedBook.Position = intCurrPos
		DisplayRecord
		ButtonState
	End If
End Sub

Sub btnRemarks_Click
	Select Case btnRemarks.Text
		Case "ADD REMARKS"
			ShowAddRemarksDialog
		Case "CHANGE REMARKS"
			blnEdit = True
			ShowEditRemarksDialog
	End Select
End Sub

Sub btnPrevious_Click
	If rsLoadedBook.Position<=0 Then Return
	rsLoadedBook.Position = rsLoadedBook.Position - 1
	If BookMark = 0 Then
		btnPrevious.Enabled=False
		Return
	End If
	btnNext.Enabled=True
	DisplayRecord
	ButtonState
	Log($"Record Position: "$ & rsLoadedBook.Position)
End Sub

Sub btnNext_Click
	If rsLoadedBook.Position = (RecCount - 1) Then Return
	rsLoadedBook.Position = rsLoadedBook.Position + 1
	If BookMark = RecCount Then
		btnNext.Enabled=False
		Return
	End If

	btnPrevious.Enabled=True
	DisplayRecord
	ButtonState
	Log($"Record Position: "$ & rsLoadedBook.Position)
End Sub

Sub btnMissCode_Click
	intCurrPos = rsLoadedBook.Position
	Log(btnMissCode.Text)
	Select Case btnMissCode.Text
		Case "CHANGE MISSCODE"
			blnEdit = True
			ShowEditMissCodeDialog
		Case "ADD MISSCODE"
			ShowAddMissCodeDialog
	End Select
End Sub

Sub btnEdit_Click
	If WasRead = 0 Then Return
	If WasMissCoded = 1 Then
		ShowEditDialog
		Return
	End If
	blnEdit = True
	txtPresRdg.Enabled=True
	txtPresRdg.RequestFocus
	txtPresRdg.SelectionStart=0
	txtPresRdg.SelectAll
	IMEkeyboard.ShowKeyboard(txtPresRdg)
	btnEdit.Enabled = False
End Sub
#End Region

#Region Search Records

Sub optSeqNo_CheckedChange(Checked As Boolean)
	If Checked=True Then
		If optUnread.Checked = True Then
			SearchAccount(0, 0)
		Else If optRead.Checked = True Then
			SearchAccount(0, 1)
		Else
			SearchAccount(0, 2)
		End If
	End If
End Sub

Sub optMeterNo_CheckedChange(Checked As Boolean)
	If Checked=True Then
		If optUnread.Checked = True Then
			SearchAccount(1, 0)
		Else If optRead.Checked = True Then
			SearchAccount(1, 1)
		Else
			SearchAccount(1, 2)
		End If
	End If
End Sub

Sub optAcctName_CheckedChange(Checked As Boolean)
	If Checked=True Then
		If optUnread.Checked = True Then
			SearchAccount(2, 0)
		Else If optRead.Checked = True Then
			SearchAccount(2, 1)
		Else
			SearchAccount(2, 2)
		End If
	End If
End Sub

Sub optUnread_CheckedChange(Checked As Boolean)
	If Checked=True Then
		If optSeqNo.Checked = True Then
			SearchAccount(0, 0)
		Else If optMeterNo.Checked = True Then
			SearchAccount(1, 0)
		Else
			SearchAccount(2, 0)
		End If
	End If
End Sub

Sub optRead_CheckedChange(Checked As Boolean)
	If Checked=True Then
		If optSeqNo.Checked = True Then
			SearchAccount(0, 1)
		Else If optMeterNo.Checked = True Then
			SearchAccount(1, 1)
		Else
			SearchAccount(2, 1)
		End If
	End If
End Sub

Sub optAll_CheckedChange(Checked As Boolean)
	If Checked=True Then
		If optSeqNo.Checked = True Then
			SearchAccount(0, 2)
		Else If optMeterNo.Checked = True Then
			SearchAccount(1, 2)
		Else
			SearchAccount(2, 2)
		End If
	End If

End Sub

Sub SV_ItemClick(Value As String)
	Log(Value)
	SearchFor = Value
	FindSearchRetValue(SearchFor)
	SV.ClearAll
	SearchClosed
End Sub

Private Sub SearchAccount(iSearchBy As Int, iFilterBy As Int)
	Dim sField1, sField2 As String
	Dim SearchList As List

	SearchList.Initialize
	SearchList.Clear

	Select Case iSearchBy
		Case 0'Meter Number
			sField1="SeqNo"
			sField2="AcctName"
			SV.et.InputType = SV.et.INPUT_TYPE_NUMBERS

		Case 1'Account Number
			sField1="MeterNo"
			sField2="AcctName"
			SV.et.InputType = SV.et.INPUT_TYPE_NUMBERS

		Case 2'Account Name
			sField1="AcctName"
			sField2="SeqNo"
			SV.et.InputType = SV.et.INPUT_TYPE_TEXT
	End Select
	
	If SV.IsInitialized=False Then
		SV.Initialize(Me,"SV")
	End If
	
	SV.ClearAll
	SV.ClearSearchBox
	SV.lv.Clear
	
	Select iFilterBy
		Case 0
			If RetrieveUnread(GlobalVar.BookID, sField1)= False Then Return
			For i = 0 To rsUnReadAcct.RowCount - 1
				rsUnReadAcct.Position=i
				Dim it As Item
				it.Title=rsUnReadAcct.GetString(sField1) & " - " & rsUnReadAcct.GetString(sField2)
				it.Text=rsUnReadAcct.GetString("AcctAddress")
				it.SearchText=rsUnReadAcct.GetString(sField1).ToLowerCase
				it.Value=rsUnReadAcct.GetString("ReadID")
'		SearchList.Add(rsLoadedBook.GetString(sField1) & " ; " & rsLoadedBook.GetString(sField2))
				SearchList.Add(it)
			Next
		Case 1
			If RetrieveRead(GlobalVar.BookID, sField1) = False Then Return
			For i = 0 To rsReadAcct.RowCount - 1
				rsReadAcct.Position=i
				Dim it As Item
				it.Title=rsReadAcct.GetString(sField1) & " - " & rsReadAcct.GetString(sField2)
				it.Text=rsReadAcct.GetString("AcctAddress")
				it.SearchText=rsReadAcct.GetString(sField1).ToLowerCase
				it.Value=rsReadAcct.GetString("ReadID")
'		SearchList.Add(rsLoadedBook.GetString(sField1) & " ; " & rsLoadedBook.GetString(sField2))
				SearchList.Add(it)
			Next
		Case 2
			If RetrieveAll(GlobalVar.BookID, sField1) = False Then Return
			For i = 0 To rsAllAcct.RowCount - 1
				rsAllAcct.Position=i
				Dim it As Item
				it.Title=rsAllAcct.GetString(sField1) & " - " & rsAllAcct.GetString(sField2)
				it.Text=rsAllAcct.GetString("AcctAddress")
				it.SearchText=rsAllAcct.GetString(sField1).ToLowerCase
				it.Value=rsAllAcct.GetString("ReadID")
'		SearchList.Add(rsLoadedBook.GetString(sField1) & " ; " & rsLoadedBook.GetString(sField2))
				SearchList.Add(it)
			Next
		Case Else
			For i = 0 To rsLoadedBook.RowCount - 1
				rsLoadedBook.Position=i
				Dim it As Item
				it.Title=rsLoadedBook.GetString(sField1) & " - " & rsLoadedBook.GetString(sField2)
				it.Text=rsLoadedBook.GetString("AcctAddress")
				it.SearchText=rsLoadedBook.GetString(sField1).ToLowerCase
				it.Value=rsLoadedBook.GetString("ReadID")
'		SearchList.Add(rsLoadedBook.GetString(sField1) & " ; " & rsLoadedBook.GetString(sField2))
				SearchList.Add(it)
			Next
	End Select
	SV.SetItems(SearchList)
	SearchList.Clear
End Sub

Sub RetrieveUnread(iBookID As Int, sOrderBy As String) As Boolean
	Dim blnRet As Boolean
	Try
		Starter.strCriteria="SELECT * FROM tblReadings " & _
							"WHERE WasRead = 0 AND BookID=" & iBookID & " AND BillYear= " & GlobalVar.BillYear  & " AND BillMonth=" & GlobalVar.BillMonth & "  ORDER BY " & sOrderBy
		Log(Starter.strCriteria)
		rsUnReadAcct=Starter.DBCon.ExecQuery(Starter.strCriteria)
		If rsUnReadAcct.RowCount>0 Then
			lblSearchRecCount.Text = $"    "$ & rsUnReadAcct.RowCount & $" Record(s) found..."$
			blnRet= True
		Else
			lblSearchRecCount.Text = $"    No Record found..."$
			blnRet=False
		End If
	Catch
		blnRet=False
		Log(LastException)
		ToastMessageShow("Unable to retreive records due to " & LastException.Message & "!",False)
	End Try
	Return blnRet
End Sub

Sub RetrieveAll(iBookID As Int, sOrderBy As String) As Boolean
	Dim blnRet As Boolean
	Try
		Starter.strCriteria="SELECT * FROM tblReadings " & _
							"WHERE BookID=" & iBookID & " AND BillYear= " & GlobalVar.BillYear & " AND BillMonth=" & GlobalVar.BillMonth & "  ORDER BY " & sOrderBy
		Log(Starter.strCriteria)
		rsAllAcct=Starter.DBCon.ExecQuery(Starter.strCriteria)
		If rsAllAcct.RowCount>0 Then
			lblSearchRecCount.Text = $"    "$ & rsAllAcct.RowCount & $" Record(s) found..."$
			blnRet= True
		Else
			lblSearchRecCount.Text = $"    No Record found..."$
			blnRet=False
		End If
	Catch
		blnRet=False
		Log(LastException)
		ToastMessageShow("Unable to retreive records due to " & LastException.Message & "!",False)
	End Try
	Return blnRet
End Sub

Sub RetrieveRead(iBookID As Int, sOrderBy As String) As Boolean
	Dim blnRet As Boolean
	Try
		Starter.strCriteria="SELECT * FROM tblReadings " & _
							"WHERE WasRead = 1 AND BookID=" & iBookID & " AND BillYear= " & GlobalVar.BillYear & " AND BillMonth=" & GlobalVar.BillMonth & " ORDER BY " & sOrderBy
		Log(Starter.strCriteria)
		rsReadAcct = Starter.DBCon.ExecQuery(Starter.strCriteria)
		If rsReadAcct.RowCount>0 Then
			lblSearchRecCount.Text = $"    "$ & rsReadAcct.RowCount & $" Record(s) found..."$
			blnRet= True
		Else
			lblSearchRecCount.Text = $"    No Record found..."$
			blnRet=False
		End If
	Catch
		blnRet=False
		Log(LastException)
		ToastMessageShow("Unable to retreive records due to " & LastException.Message & "!",False)
	End Try
	Return blnRet
End Sub

Sub btnCancelSearch_Click
	SearchClosed
	rsLoadedBook.Position = intTempCurrPos
	DisplayRecord
	ButtonState
End Sub


Sub SearchClosed
	SearchFor = ""
	SV.ClearSearchBox
	SV.ClearAll
'	SV.RemoveView
	pnlSearch.Visible=False
	pnlUnusual.Visible = False
'	SetButtonColors
	EnableControls
End Sub

Sub FindSearchRetValue(sSearch As String)
	Try
		Log(rsLoadedBook.Position)
'		rsLoadedBook.Position=0
		For i = 0 To rsLoadedBook.RowCount - 1
			rsLoadedBook.Position = i
			If sSearch = rsLoadedBook.GetString("ReadID") Then
				ReadID = sSearch
				BookMark = rsLoadedBook.Position + 1
				DisplayRecord
				ButtonState
				Exit
			End If
		Next
		Log(rsLoadedBook.Position)
	Catch
		Log(LastException)
	End Try
End Sub
#End Region

#Region Styles
Sub SetSnackBarBackground(pSnack As DSSnackbar, pColor As Int)
	Dim v As View
	v = pSnack.View
	v.Color = pColor
End Sub

Sub SetSnackBarTextColor(pSnack As DSSnackbar, pColor As Int)
	Dim p As Panel
	p = pSnack.View
	For Each v As View In p.GetAllViewsRecursive
		If v Is Label Then
			Dim textv As Label
			textv = v
			textv.TextColor = pColor
			Exit
		End If
	Next
End Sub
#End Region

#Region Adding MissCodeOnly
Private Sub ShowAddMissCodeDialog
	Dim csTitle As CSBuilder
	Dim csContent As CSBuilder
	
	csTitle.Initialize.Color(Colors.Red).Size(16).Bold.Append($"ADD MISS CODE ENTRY"$).PopAll
	csContent.Initialize.Bold.Color(Colors.Red).Size(14).Append(CRLF & $"WARNING!"$).Pop.Pop
	csContent.Color(Colors.DarkGray).Append(CRLF & $"You cannot ENTER Meter Reading for this customer."$).Pop.Pop.Color(GlobalVar.PriColor).Append(CRLF & CRLF & $"Please select a code from the list..."$).PopAll
	
	MatDialogBuilder.Initialize("AddNewMissCode")
	MatDialogBuilder.Theme(MatDialogBuilder.THEME_LIGHT)
	MatDialogBuilder.Title(csTitle).TitleColor(Colors.Red).TitleGravity(MatDialogBuilder.GRAVITY_START)
	MatDialogBuilder.IconRes(GlobalVar.WarningIcon).LimitIconToDefaultSize
	MatDialogBuilder.Content(csContent)
	MatDialogBuilder.Items(Array As String("Biting Dog", "Meter/Gate Locked", "Meter Not Found", "Hard to Read", "No Entry", "Meter Flooded", "Meter Removed", "Deffective Meter", "Others"))
	MatDialogBuilder.ItemsCallbackSingleChoice(8)
	MatDialogBuilder.PositiveText($"SELECT"$).PositiveColor(GlobalVar.PriColor)
	MatDialogBuilder.NegativeText($"CANCEL"$).NegativeColor(Colors.Red)
	MatDialogBuilder.CanceledOnTouchOutside(False)
	MatDialogBuilder.Show
End Sub

Sub AddNewMissCode_SingleChoiceItemSelected (mDialog As MaterialDialog, iPosition As Int, sDesc As String)
	MissCodeID = iPosition + 1
	MissCode = sDesc
End Sub

Sub AddNewMissCode_ButtonPressed (mDialog As MaterialDialog, sAction As String)
	Select Case sAction
		Case mDialog.ACTION_POSITIVE
			Select Case MissCodeID
				Case 9
					ShowAddOtherMissCodeDialog
				Case Else
					'Save Miss Code
					intCurrPos = rsLoadedBook.Position
					SaveMissCodeOnly(MissCodeID, MissCode, ReadID, AcctID)
					If RetrieveRecords(GlobalVar.BookID)=False Then Return
					If intCurrPos < (RecCount - 1) Then
						rsLoadedBook.Position = intCurrPos + 1
					Else
						rsLoadedBook.Position = intCurrPos
					End If
					DisplayRecord
					ButtonState
					If GetUnusualCount(GlobalVar.BookID) = True Then
						UpdateBadge("Flag", AddBadgeToIcon(flagBitmap, intTotal))
					End If
			End Select
			
		Case mDialog.ACTION_NEGATIVE
			snack.Initialize("", Activity, $"Adding Miss Code entry cancelled."$ ,snack.DURATION_SHORT)
			SetSnackBarBackground(snack, Colors.White)
			SetSnackBarTextColor(snack, Colors.Red)
			snack.Show
			Return
	End Select
End Sub

Private Sub ShowAddOtherMissCodeDialog
	Dim csContent As CSBuilder

	csContent.Initialize.Size(14).Color(Colors.DarkGray).Append($"Enter Other Miss Code Data."$).PopAll
	MatDialogBuilder.Initialize("AddNewOtherMissCodeDialog")
	MatDialogBuilder.Theme(MatDialogBuilder.THEME_LIGHT)
	MatDialogBuilder.Title($"ADD OTHER MISS CODE ENTRY"$).TitleGravity(MatDialogBuilder.GRAVITY_START)
	MatDialogBuilder.IconRes(GlobalVar.WarningIcon).LimitIconToDefaultSize
	MatDialogBuilder.InputType(Bit.Or(Bit.Or(MatDialogBuilder.TYPE_CLASS_TEXT, MatDialogBuilder.TYPE_TEXT_FLAG_CAP_SENTENCES), MatDialogBuilder.TYPE_TEXT_VARIATION_PERSON_NAME))
	MatDialogBuilder.Input2($"Type your Miss Code Reason here..."$, $"Inactive Account"$, False)
	MatDialogBuilder.AlwaysCallInputCallback
	MatDialogBuilder.Content(csContent)
	MatDialogBuilder.PositiveText($"SAVE"$).PositiveColor(GlobalVar.PriColor)
	MatDialogBuilder.NegativeText($"CANCEL"$).NegativeColor(Colors.Red)
	MatDialogBuilder.CanceledOnTouchOutside(False)
	MatDialogBuilder.Show
End Sub

Sub AddNewOtherMissCodeDialog_InputChanged (mDialog As MaterialDialog, sRemarks As String)
	If sRemarks.Length = 0 Then
		mDialog.EnableActionButton(mDialog.ACTION_NEGATIVE, False)
		mDialog.EnableActionButton(mDialog.ACTION_POSITIVE, False)
	Else
		mDialog.EnableActionButton(mDialog.ACTION_NEGATIVE, True)
		mDialog.EnableActionButton(mDialog.ACTION_POSITIVE, True)
	End If
	MissCode = sRemarks
End Sub

Sub AddNewOtherMissCodeDialog_ButtonPressed (Dialog As MaterialDialog, Action As String)
	Select Case Action
		Case Dialog.ACTION_POSITIVE
			intCurrPos = rsLoadedBook.Position
			SaveMissCodeOnly(9, MissCode, ReadID, AcctID)
			If RetrieveRecords(GlobalVar.BookID) = False Then Return
			If intCurrPos < (RecCount - 1) Then
				rsLoadedBook.Position = intCurrPos + 1
			Else
				rsLoadedBook.Position = intCurrPos
			End If
			DisplayRecord
			ButtonState
			If GetUnusualCount(GlobalVar.BookID) = True Then
				UpdateBadge("Flag", AddBadgeToIcon(flagBitmap, intTotal))
			End If
			
		Case Dialog.ACTION_NEGATIVE
			snack.Initialize("",Activity,$"Adding Other Miss Code Entry Cancelled"$,snack.DURATION_SHORT)
			SetSnackBarBackground(snack, Colors.Red)
			SetSnackBarTextColor(snack, Colors.White)
			snack.Show
	End Select
End Sub

Private Sub ShowEditMissCodeDialog
	Dim csContent As CSBuilder
	Dim csTitle As CSBuilder

	csTitle.Initialize.Color(Colors.Red).Size(16).Bold.Append($"EDIT MISS CODE ENTRY"$).PopAll
	csContent.Initialize.Bold.Color(Colors.Red).Size(14).Append(CRLF & $"WARNING!"$).Pop.Pop
	csContent.Color(Colors.DarkGray).Append(CRLF & $"You cannot ENTER Meter Reading for this customer."$).Pop.Pop.Color(GlobalVar.PriColor).Append(CRLF & CRLF & $"Please select a code from the list..."$).PopAll
	
	MatDialogBuilder.Initialize("EditMissCode")
	MatDialogBuilder.Theme(MatDialogBuilder.THEME_LIGHT)
	MatDialogBuilder.Title(csTitle).TitleGravity(MatDialogBuilder.GRAVITY_START)
	MatDialogBuilder.IconRes(GlobalVar.WarningIcon).LimitIconToDefaultSize
	MatDialogBuilder.Content(csContent)
	MatDialogBuilder.Items(Array As String("Bitting Dog", "Meter/Gate Locked", "Meter Not Found", "Hard to Read", "No Entry", "Meter Flooded", "Meter Removed", "Deffective Meter", "Others"))
	MatDialogBuilder.ItemsCallbackSingleChoice(8)
	MatDialogBuilder.PositiveText($"SELECT"$).PositiveColor(GlobalVar.PriColor)
	MatDialogBuilder.NegativeText($"CANCEL"$).NegativeColor(Colors.Red)
	MatDialogBuilder.CanceledOnTouchOutside(False)
	MatDialogBuilder.Show
End Sub

Sub EditMissCode_SingleChoiceItemSelected (mDialog As MaterialDialog, iPosition As Int, sDesc As String)
	MissCodeID = iPosition + 1
	MissCode = sDesc
End Sub

Sub EditMissCode_ButtonPressed (mDialog As MaterialDialog, sAction As String)
	Select Case sAction
		Case mDialog.ACTION_POSITIVE
			Select Case MissCodeID
				Case 9
					ShowAddOtherMissCodeDialog
				Case Else
					'Save Miss Code
					intCurrPos = rsLoadedBook.Position
					SaveMissCodeOnly(MissCodeID, MissCode, ReadID, AcctID)
					If RetrieveRecords(GlobalVar.BookID)=False Then Return
					If intCurrPos < (RecCount - 1) Then
						rsLoadedBook.Position = intCurrPos + 1
					Else
						rsLoadedBook.Position = intCurrPos
					End If
					DisplayRecord
					ButtonState
					If GetUnusualCount(GlobalVar.BookID) = True Then
						UpdateBadge("Flag", AddBadgeToIcon(flagBitmap, intTotal))
					End If
			End Select
			
		Case mDialog.ACTION_NEGATIVE
			snack.Initialize("", Activity, $"Adding Miss Code entry cancelled."$ ,snack.DURATION_SHORT)
			SetSnackBarBackground(snack, Colors.White)
			SetSnackBarTextColor(snack, Colors.Red)
			snack.Show
			Return
	End Select
End Sub

Private Sub SaveMissCodeOnly(iMissCodeID As Int, sMissCodeDesc As String, iReadID As Int, iAcctID As Int)
	Dim lngDateTime As Long
	Dim Findings As String
	Dim sWarning As String
	lngDateTime = DateTime.Now
	DateTime.TimeFormat = "HH:mm:ss"
	TimeRead = DateTime.Time(lngDateTime)
	DateTime.DateFormat = "MM/dd/yyyy"
	DateRead = DateTime.Date(lngDateTime)

	NoInput = NoInput + 1
	If IsNumber(txtPresRdg.Text) Then
		TotalCum = lblPresCum.Text + AddCons
	Else
		TotalCum = 0
	End If
	If lblPresCum.Text.Length <=0 Then
		Findings = "No Reading"
	Else
		If strSF.Val(lblPresCum.Text) < 0 Then
			Findings = "Negative Consumption"
		End If
	End If
	
	sWarning = GetWarning(PrevCum, strSF.Val(lblPresCum.Text))
	
	Try
		Starter.DBCon.BeginTransaction
		If blnEdit = True Then
			Starter.strCriteria="UPDATE tblReadings " & _
							"SET WasMissCoded = ?, MissCodeID = ?, MissCode = ?, fFindings = ?, fWarnings = ?, OrigRdg = ?, PresRdg = ?, PresCum = ?, TotalCum = ?, " & _
							"WasRead = ?, NoInput = ?, TimeRead = ?, DateRead = ? " & _
							"WHERE ReadID = " & iReadID & " " & _
							"And AcctID = " & iAcctID

			Starter.DBCon.ExecNonQuery2(Starter.strCriteria, Array As String($"1"$, iMissCodeID, sMissCodeDesc, Findings, sWarning, txtPresRdg.Text, txtPresRdg.Text, lblPresCum.Text, TotalCum, _
							 $"1"$, NoInput, TimeRead, DateRead))

			snack.Initialize("", Activity, $"Miss Code Entry was successfully updated"$, snack.DURATION_SHORT)
			SetSnackBarBackground(snack, GlobalVar.PriColor)
			SetSnackBarTextColor(snack, Colors.White)
			snack.Show
			blnEdit = False
		Else
			NewSeqNo = DBaseFunctions.GetSeqNo(GlobalVar.BookID)
			Starter.strCriteria="UPDATE tblReadings " & _
							"SET WasMissCoded = ?, MissCodeID = ?, MissCode = ?, fFindings = ?, fWarnings = ?, OrigRdg = ?, PresRdg = ?, PresCum = ?, TotalCum = ?, MissCoded = ?, " & _
							"WasRead = ?, NewSeqNo = ?, NoInput = ?, TimeRead = ?, DateRead = ? " & _
							"WHERE ReadID = " & iReadID & " " & _
							"And AcctID = " & iAcctID

			Starter.DBCon.ExecNonQuery2(Starter.strCriteria, Array As String($"1"$, iMissCodeID, sMissCodeDesc, Findings, sWarning, txtPresRdg.Text, txtPresRdg.Text, lblPresCum.Text, TotalCum, $"1"$, _
							$"1"$, NewSeqNo, NoInput, TimeRead, DateRead))
			snack.Initialize("", Activity, $"Miss Code Entry was successfully saved!"$, snack.DURATION_SHORT)
			SetSnackBarBackground(snack, GlobalVar.PriColor)
			SetSnackBarTextColor(snack, Colors.White)
			snack.Show
		End If
		Starter.DBCon.TransactionSuccessful
	Catch
		Log(LastException)
	End Try
	Starter.DBCon.EndTransaction
End Sub
#End Region

#Region Add Remarks
Sub ShowAddRemarksDialog
	Dim csContent As CSBuilder
	
	csContent.Initialize.Size(16).Color(Colors.DarkGray).Append($"Please enter a remarks for this account."$).PopAll
	MatDialogBuilder.Initialize("AddRemarksDialog")
	MatDialogBuilder.Theme(MatDialogBuilder.THEME_LIGHT)
	MatDialogBuilder.Title($"ADD READING REMARKS"$).TitleColor(Colors.Red).TitleGravity(MatDialogBuilder.GRAVITY_START)
	MatDialogBuilder.IconRes(GlobalVar.WarningIcon).LimitIconToDefaultSize
	MatDialogBuilder.InputType(Bit.Or(Bit.Or(MatDialogBuilder.TYPE_CLASS_TEXT, MatDialogBuilder.TYPE_TEXT_FLAG_CAP_SENTENCES), MatDialogBuilder.TYPE_TEXT_VARIATION_PERSON_NAME))
	MatDialogBuilder.Input2($"Type your Remarks here..."$, $""$, False)
	MatDialogBuilder.AlwaysCallInputCallback
	MatDialogBuilder.Content(csContent)
	MatDialogBuilder.PositiveText($"SAVE"$).PositiveColor(GlobalVar.PriColor)
	MatDialogBuilder.NegativeText($"CANCEL"$).NegativeColor(Colors.Red)
	MatDialogBuilder.CanceledOnTouchOutside(False)
	MatDialogBuilder.Show
End Sub

Sub AddRemarksDialog_InputChanged (mDialog As MaterialDialog, sRemarks As String)
	If sRemarks.Length=0 Then
		mDialog.Content="Nothing to save."
		mDialog.EnableActionButton(mDialog.ACTION_POSITIVE, False)
	Else
		mDialog.Content="Please Enter a Remarks for this Account."
		mDialog.EnableActionButton(mDialog.ACTION_POSITIVE, True)
	End If
	ReadRemarks = sRemarks
End Sub

Sub AddRemarksDialog_ButtonPressed (Dialog As MaterialDialog, Action As String)
	Select Case Action
		Case Dialog.ACTION_POSITIVE
			intCurrPos = rsLoadedBook.Position
			SaveNewRemarks(ReadRemarks, ReadID, AcctID)
			If RetrieveRecords(GlobalVar.BookID)=False Then Return
			If intCurrPos < (RecCount - 1) Then
				rsLoadedBook.Position = intCurrPos + 1
			Else
				rsLoadedBook.Position = intCurrPos
			End If
			DisplayRecord
			ButtonState
		Case Dialog.ACTION_NEGATIVE
			snack.Initialize("", Activity, $"Adding Reading Remarks Cancelled."$ ,snack.DURATION_SHORT)
			SetSnackBarBackground(snack, Colors.White)
			SetSnackBarTextColor(snack, Colors.Red)
			snack.Show
			Return
	End Select
End Sub

Sub ShowEditRemarksDialog
	Dim csContent As CSBuilder
	
	csContent.Initialize.Size(16).Color(Colors.DarkGray).Append($"Please enter a remarks for this account."$).PopAll
	MatDialogBuilder.Initialize("EditRemarksDialog")
	MatDialogBuilder.Theme(MatDialogBuilder.THEME_LIGHT)
	MatDialogBuilder.Title($"EDIT READING REMARKS"$).TitleColor(Colors.Red).TitleGravity(MatDialogBuilder.GRAVITY_START)
	MatDialogBuilder.IconRes(GlobalVar.WarningIcon).LimitIconToDefaultSize
	MatDialogBuilder.InputType(Bit.Or(Bit.Or(MatDialogBuilder.TYPE_CLASS_TEXT, MatDialogBuilder.TYPE_TEXT_FLAG_CAP_SENTENCES), MatDialogBuilder.TYPE_TEXT_VARIATION_PERSON_NAME))
	MatDialogBuilder.Input2($"Type your Remarks here..."$, $""$, False)
	MatDialogBuilder.AlwaysCallInputCallback
	MatDialogBuilder.Content(csContent)
	MatDialogBuilder.PositiveText($"UPDATE"$).PositiveColor(GlobalVar.PriColor)
	MatDialogBuilder.NegativeText($"CANCEL"$).NegativeColor(Colors.Red)
	MatDialogBuilder.CanceledOnTouchOutside(False)
	MatDialogBuilder.Show
End Sub

Sub EditRemarksDialog_InputChanged (mDialog As MaterialDialog, sRemarks As String)
	If sRemarks.Length=0 Then
		mDialog.Content="Nothing to save."
		mDialog.EnableActionButton(mDialog.ACTION_POSITIVE, False)
	Else
		mDialog.Content="Please Enter a Remarks for this Account."
		mDialog.EnableActionButton(mDialog.ACTION_POSITIVE, True)
	End If
	ReadRemarks = sRemarks
End Sub

Sub EditRemarksDialog_ButtonPressed (Dialog As MaterialDialog, Action As String)
	Select Case Action
		Case Dialog.ACTION_POSITIVE
			intCurrPos = rsLoadedBook.Position
			SaveNewRemarks(ReadRemarks, ReadID, AcctID)
			If RetrieveRecords(GlobalVar.BookID)=False Then Return
			If intCurrPos < (RecCount - 1) Then
				rsLoadedBook.Position = intCurrPos + 1
			Else
				rsLoadedBook.Position = intCurrPos
			End If
			DisplayRecord
			ButtonState
		Case Dialog.ACTION_NEGATIVE
			snack.Initialize("", Activity, $"Editting Reading Remarks Cancelled."$ ,snack.DURATION_SHORT)
			SetSnackBarBackground(snack, Colors.White)
			SetSnackBarTextColor(snack, Colors.Red)
			snack.Show
			Return
	End Select
End Sub

Private Sub SaveNewRemarks(sRemarks As String, iReadID As Int, iAcctID As Int)
	Dim intWasBlank As Int
	
	Try
		NoInput = NoInput + 1
		Starter.DBCon.BeginTransaction
		Starter.strCriteria="UPDATE tblReadings " & _
							"SET ReadRemarks = ?, NoInput = ? " & _
							"WHERE ReadID = " & iReadID & " " & _
							"AND AcctID = " & iAcctID

		Starter.DBCon.ExecNonQuery2(Starter.strCriteria, Array As String(sRemarks, NoInput))
		Starter.DBCon.TransactionSuccessful
		If blnEdit = True Then
			snack.Initialize("", Activity, $"Remarks Entry was successfully updated!"$, snack.DURATION_LONG)
			SetSnackBarBackground(snack, GlobalVar.PriColor)
			SetSnackBarTextColor(snack, Colors.White)
			snack.Show
		Else
			snack.Initialize("", Activity, $"Remarks Entry was successfully added!"$, snack.DURATION_LONG)
			SetSnackBarBackground(snack, GlobalVar.PriColor)
			SetSnackBarTextColor(snack, Colors.White)
			snack.Show
		End If
	Catch
		Log(LastException)
	End Try
	Starter.DBCon.EndTransaction
End Sub
#End Region

#Region Saving Readings
Private Sub SaveReading(iPrintStatus As Int, iReadID As Int, iAcctID As Int)
	Dim lngDateTime As Long
	Dim sFindings, sWarning As String
	Dim MinimumRangeTo As Int
	'Update **************************************
	
	BasicAmt = 0
	lngDateTime = DateTime.Now
	DateTime.TimeFormat = "HH:mm:ss"
	TimeRead = DateTime.Time(lngDateTime)
	DateTime.DateFormat = "MM/dd/yyyy"
	DateRead = DateTime.Date(lngDateTime)
	
	TotalCum = strSF.Val(lblPresCum.Text) + AddCons
	
	'****
'	intRateHeaderID = DBaseFunctions.GetRatesHeaderID(AcctClass, AcctSubClass)
	ImplosiveType = GetImplosiveType(PrevCum, strSF.Val(lblPresCum.Text))
	sWarning = GetWarning(PrevCum, strSF.Val(lblPresCum.Text))
	
	NoInput = NoInput + 1
	WasRead = 1
	
	PrintStatus = iPrintStatus
	
	If PrintStatus = 1 Then
		NoPrinted = NoPrinted + 1
	Else
		NoPrinted = NoPrinted
	End If
	
	BasicAmt = DBaseFunctions.ComputeBasicAmt(strSF.Val(TotalCum), GlobalVar.BranchID, AcctClass, AcctSubClass, GlobalVar.BillYear & "-" & GlobalVar.BillMonth & "-01")
	
'/////////////// Discount HWRI //////////////////////////////
	'26 (HWRI - Matungao Branch) - All Residential (48.50)
	'27 (HWRI - Bustos Branch) - All Residential (40.00)
	'28 (HWRI - Malis Branch) - All Residential with 0-20 CuM (42.50)
	'29 (HWRI - Agatha Branch) - All Residential with 0-20 CuM (42.50)
	'30 (HWRI - Tuktukan Branch) - All Residential with 0-20 CuM (42.50)
	'36 (HWRI - Paombong Branch) - All Residential (97.00)
	'58 (HWRI - San Francisco Branch)- All Residential (48.50)
	
'	If GlobalVar.BillMonth = 5 And GlobalVar.BillYear = 2020 Then ' May 2020 Bills only
'		If GlobalVar.BranchID = 26 Or GlobalVar.BranchID = 58 Then 'Bulakan
'			If AcctClass = "RES" Then
'				DiscAmt = 48.50
'			Else
'				DiscAmt = 0
'			End If
'		End If
'		If GlobalVar.BranchID = 27 Then 'Bustos
'			If AcctClass = "RES" Then
'				DiscAmt = 40.00
'			Else
'				DiscAmt = 0
'			End If
'		End If
'		If GlobalVar.BranchID = 28 Or GlobalVar.BranchID = 29 Or GlobalVar.BranchID = 30 Then ' Guiguinto
'			If AcctClass = "RES" Then
'				If TotalCum <= 20 Then
'					DiscAmt = 42.50
'				Else
'					DiscAmt = 0
'				End If
'			Else
'				DiscAmt = 0
'			End If
'		End If
'		If GlobalVar.BranchID = 36 Then 'Paombong
'			If AcctClass = "RES" Then
'				DiscAmt = 97.00
'			Else
'				DiscAmt = 0
'			End If
'		End If
'		If GlobalVar.BranchID = 67 Then 'Villa Louise
'			DiscAmt = 48.25
'		End If
'	Else
'		DiscAmt = 0
'	End If

'	If GlobalVar.BranchID = 25 And GlobalVar.BillYear = 2020 And GlobalVar.BillMonth = 4 Then 'Balagtas Branch ID
'		If AcctClass = "RES" Then
'			'Get the Rate Header ID depends on subclass
'			intRateHeaderID = DBaseFunctions.GetRatesResHeaderID(AcctSubClass)
'			'Get the Minimum amount of RES(AcctSubClass) Rate and multiply it by 50%
'			DiscAmt = DBaseFunctions.GetMinimumRate(intRateHeaderID) * 0.5
'		Else
'			DiscAmt = 0
'		End If
'	Else
'		DiscAmt = 0
'	End If
'///////////////////////////////////////////////////////////////////////////////////////////////////////
	'BasicAmt = DBaseFunctions.ComputeBasicAmt(strSF.Val(TotalCum), GlobalVar.BranchID, AcctClass, AcctSubClass, GlobalVar.BillYear & "-" & GlobalVar.BillMonth & "-01")
	
	If DBaseFunctions.IsBookWithPCA(GlobalVar.BookID) = True Then
		MinimumRangeTo = DBaseFunctions.GetMinimumRangeTo(GlobalVar.BranchID, AcctClass, AcctSubClass, GlobalVar.BillYear & "-" & GlobalVar.BillMonth & "-01")
		If TotalCum <= MinimumRangeTo Then
			PCAAmt = MinimumRangeTo * PCA
		Else
			PCAAmt = TotalCum * PCA
		End If
	Else
		PCAAmt = 0
	End If
	
	CurrentAmt = BasicAmt + PCAAmt
	FranchiseTaxAmt = (CurrentAmt * FranchiseTaxPct)

	If IsSenior = 1 Then
		SeniorOnBeforeAmt = GetSeniorBefore(ReadID, TotalCum)
		SeniorAfterAmt = GetSeniorAfter(ReadID, TotalCum)
	Else
		SeniorAfterAmt = 0
		SeniorOnBeforeAmt = 0
	End If
	
	'Discount for the Month of June 2020
	If GlobalVar.BillYear = 2020 And GlobalVar.BillMonth = 6 Then
		If GlobalVar.BranchID = 59 Then 'Salintubig
			DiscAmt = (CurrentAmt * 0.5) + 48.25
		Else If GlobalVar.BranchID = 67 Then 'Louise
			DiscAmt = (CurrentAmt * 0.5)
		Else
			DiscAmt = 0
		End If
	Else
		DiscAmt = 0
	End If
	
	TotalDueAmtBeforeSC = CurrentAmt - SeniorOnBeforeAmt - DiscAmt
	Dim dSeptageAmt As Double
	
	If AcctClass = "RES" Then
		dSeptageAmt = 3
	else If AcctClass = "COM" Then
		dSeptageAmt = 7
	else If AcctClass = "GOV" Then
		dSeptageAmt = 5
	End If
	
	If HasSeptageFee = 1 Then
		MinimumRangeTo = DBaseFunctions.GetMinimumRangeTo(GlobalVar.BranchID, AcctClass, AcctSubClass, GlobalVar.BillYear & "-" & GlobalVar.BillMonth & "-01")
		If TotalCum <= MinimumRangeTo Then
			SeptageFeeAmt = MinimumRangeTo * dSeptageAmt
		Else
			If TotalCum >= MaxSeptageCum Then
				SeptageFeeAmt = MaxSeptageCum * dSeptageAmt
			Else
				SeptageFeeAmt = TotalCum * dSeptageAmt
			End If
'			SeptageFeeAmt = TotalCum * dSeptageAmt
		End If
	Else
		SeptageFeeAmt = 0
	End If
	
'	If ((CurrentAmt + AddToBillAmt + ArrearsAmt) - SeniorOnBeforeAmt) < AdvPayment Then
'		TotalDueAmt = 0
'	Else
'		TotalDueAmt = CurrentAmt + AddToBillAmt + ArrearsAmt - (AdvPayment + SeniorOnBeforeAmt)
'	End If

	If ((CurrentAmt + AddToBillAmt + ArrearsAmt + MeterCharges + FranchiseTaxAmt + SeptageFeeAmt) - (SeniorOnBeforeAmt + DiscAmt)) < AdvPayment Then
		TotalDueAmt = 0
	Else
		TotalDueAmt = CurrentAmt + AddToBillAmt + ArrearsAmt + MeterCharges + FranchiseTaxAmt + SeptageFeeAmt - (AdvPayment + SeniorOnBeforeAmt + DiscAmt)
	End If

	If AdvPayment > CurrentAmt Then
		PenaltyAmt = 0
	Else
		PenaltyAmt = (CurrentAmt - AdvPayment) * PenaltyPct
	End If

	If ((CurrentAmt + AddToBillAmt + ArrearsAmt + MeterCharges + FranchiseTaxAmt + SeptageFeeAmt) - (SeniorAfterAmt + DiscAmt)) < AdvPayment Then
		TotalDueAmtAfterSC = 0
	Else
		TotalDueAmtAfterSC = CurrentAmt + AddToBillAmt + ArrearsAmt + MeterCharges + FranchiseTaxAmt + SeptageFeeAmt - (AdvPayment + SeniorAfterAmt + DiscAmt) + PenaltyAmt
	End If
	
'	If WithDueDate = 1 Then
'		If AdvPayment > CurrentAmt Then
'			PenaltyAmt = 0
'		Else
'			PenaltyAmt = (CurrentAmt - AdvPayment) * PenaltyPct
'		End If
	'
'		If (CurrentAmt + AddToBillAmt + ArrearsAmt + MeterCharges + FranchiseTaxAmt + SeptageFeeAmt) - SeniorAfterAmt < AdvPayment Then
'			TotalDueAmtAfterSC = 0
'		Else
'			TotalDueAmtAfterSC = CurrentAmt + AddToBillAmt + ArrearsAmt + MeterCharges + FranchiseTaxAmt + SeptageFeeAmt - (AdvPayment + SeniorAfterAmt) + PenaltyAmt
'		End If
'	Else
'		If AdvPayment > CurrentAmt Then
'			PenaltyAmt = 0
'		Else
'			PenaltyAmt = (CurrentAmt - AdvPayment) * 0
'		End If
	'
'		If (CurrentAmt + AddToBillAmt + ArrearsAmt + MeterCharges + FranchiseTaxAmt + SeptageFeeAmt) - SeniorAfterAmt < AdvPayment Then
'			TotalDueAmtAfterSC = 0
'		Else
'			TotalDueAmtAfterSC = CurrentAmt + AddToBillAmt + ArrearsAmt + MeterCharges + FranchiseTaxAmt + SeptageFeeAmt - (AdvPayment + SeniorAfterAmt) + PenaltyAmt
'		End If
'	End If

	
	Starter.DBCon.BeginTransaction
	Try
		If blnEdit = True Then
			Starter.strCriteria = "UPDATE tblReadings " & _
							  "SET PresRdg = ?, PresCum = ?, TotalCum = ?, BasicAmt = ?, PCAAmt = ?, SeptageAmt = ?, " & _
							  "CurrentAmt = ?, TotalDueAmt = ?, SeniorOnBeforeAmt = ?, SeniorAfterAmt = ?, TotalDueAmtBeforeSC = ?, PenaltyAmt = ?, TotalDueAmtAfterSC = ?, DiscAmt = ?, FranchiseTaxAmt = ?, " & _
							  "PrintStatus = ?, NoPrinted = ?, WasMissCoded = ?, MissCodeID = ?, MissCode = ?, WasImplosive = ?, ImplosiveType = ?, ImpID = ?, FFindings = ?, FWarnings = ?, ReadRemarks = ?, " & _
							  "BillType = ?, WasRead = ?, NoInput = ?, TimeRead = ? " & _
							  "WHERE ReadID = " & iReadID & " " & _
							  "AND AcctID = " & iAcctID
		
			Starter.DBCon.ExecNonQuery2(Starter.strCriteria, Array As String(txtPresRdg.Text, lblPresCum.Text, TotalCum, BasicAmt, PCAAmt, SeptageFeeAmt, _
							  CurrentAmt, TotalDueAmt, SeniorOnBeforeAmt, SeniorAfterAmt, TotalDueAmtBeforeSC, PenaltyAmt, TotalDueAmtAfterSC, DiscAmt, FranchiseTaxAmt, _
							  PrintStatus, NoPrinted, $"0"$, $"0"$, $""$, $"0"$, ImplosiveType, $"0"$, $"Actual Reading"$, sWarning, strReadRemarks, _
							  $"RB"$, $"1"$, NoInput, TimeRead))

'			snack.Initialize("",Activity, $"Reading has been successfully updated."$, snack.DURATION_LONG)
'			SetSnackBarBackground(snack, GlobalVar.PriColor)
'			SetSnackBarTextColor(snack, Colors.White)
'			snack.Show
			blnEdit = False
		Else
			NewSeqNo = DBaseFunctions.GetSeqNo(GlobalVar.BookID)
			Starter.strCriteria = "UPDATE tblReadings " & _
							  "SET OrigRdg = ?, PresRdg = ?, PresCum = ?, TotalCum = ?, BasicAmt = ?, PCAAmt = ?, SeptageAmt = ?, " & _
							  "CurrentAmt = ?, TotalDueAmt = ?, SeniorOnBeforeAmt = ?, SeniorAfterAmt = ?, TotalDueAmtBeforeSC = ?, PenaltyAmt = ?, TotalDueAmtAfterSC = ?, DiscAmt = ?, FranchiseTaxAmt = ?, " & _
							  "PrintStatus = ?, NoPrinted = ?, WasMissCoded = ?, MissCodeID = ?, MissCode = ?, WasImplosive = ?, ImplosiveType = ?, ImpID = ?, FFindings = ?, FWarnings = ?, ReadRemarks = ?, " & _
							  "BillType = ?, WasRead = ?, NewSeqNo = ?, NoInput = ?, TimeRead = ?, DateRead = ? " & _
							  "WHERE ReadID = " & iReadID & " " & _
							  "AND AcctID = " & iAcctID
		
			Starter.DBCon.ExecNonQuery2(Starter.strCriteria, Array As String(txtPresRdg.Text, txtPresRdg.Text, lblPresCum.Text, TotalCum, BasicAmt, PCAAmt, SeptageFeeAmt, _
							  CurrentAmt, TotalDueAmt, SeniorOnBeforeAmt, SeniorAfterAmt, TotalDueAmtBeforeSC, PenaltyAmt, TotalDueAmtAfterSC, DiscAmt, FranchiseTaxAmt, _
							  PrintStatus, NoPrinted, $"0"$, $"0"$, $""$, $"0"$, ImplosiveType, $"0"$, $"Actual Reading"$, sWarning, strReadRemarks, _
							  $"RB"$, $"1"$, NewSeqNo, NoInput, TimeRead, DateRead))
'			snack.Initialize("",Activity, $"New Reading has been successfully posted."$, snack.DURATION_LONG)
'			SetSnackBarBackground(snack, GlobalVar.PriColor)
'			SetSnackBarTextColor(snack, Colors.White)
'			snack.Show
		End If
		Starter.DBCon.TransactionSuccessful
	Catch
		Log(LastException.Message)
	End Try
	Starter.DBCon.EndTransaction
End Sub

'Private Sub SaveAverageBill(iPrintStatus As Int, iReadID As Int, iAcctID As Int)
'	Dim lngDateTime As Long
'	Dim sFindings, sWarning As String
'	Dim MinimumRangeTo As Int
'	Dim MaxMinimum As Int
'	Dim sAveCum As String
'	
'	BasicAmt = 0
'	lngDateTime = DateTime.Now
'	DateTime.TimeFormat = "HH:mm:ss"
'	TimeRead = DateTime.Time(lngDateTime)
'	DateTime.DateFormat = "MM/dd/yyyy"
'	DateRead = DateTime.Date(lngDateTime)
'	
'
'	
'	ImplosiveType = $"posted"$
'	sWarning = $"Average Bill"$
'	
'	NoInput = NoInput + 1
'	WasRead = 1
'	
'	PrintStatus = iPrintStatus
'	
'	If PrintStatus = 1 Then
'		NoPrinted = NoPrinted + 1
'	Else
'		NoPrinted = NoPrinted
'	End If
'	
''	TotalCum = strSF.Val(lblPresCum.Text) + AddCons
'	sAveCum = AveCum
'	If IsNumber(sAveCum) = False Then
'		TotalCum = DBaseFunctions.GetMinimumRangeTo(GlobalVar.BranchID, AcctClass, AcctSubClass, GlobalVar.BillYear & "-" & GlobalVar.BillMonth & "-01") + AddCons
'		PresAveCum = DBaseFunctions.GetMinimumRangeTo(GlobalVar.BranchID, AcctClass, AcctSubClass, GlobalVar.BillYear & "-" & GlobalVar.BillMonth & "-01") + AddCons
'		PresAveRdg = PrevRdg + TotalCum
'	Else
'		TotalCum = AveCum + AddCons
'		PresAveCum = AveCum + AddCons
'		PresAveRdg = PrevRdg + AveCum
'	End If
'	
'	BasicAmt = DBaseFunctions.ComputeBasicAmt(strSF.Val(PresAveCum), GlobalVar.BranchID, AcctClass, AcctSubClass, GlobalVar.BillYear & "-" & GlobalVar.BillMonth & "-01")
'	
'	If DBaseFunctions.IsBookWithPCA(GlobalVar.BookID) = True Then
'		MinimumRangeTo = DBaseFunctions.GetMinimumRangeTo(GlobalVar.BranchID, AcctClass, AcctSubClass, GlobalVar.BillYear & "-" & GlobalVar.BillMonth & "-01")
'		If TotalCum <= MinimumRangeTo Then
'			PCAAmt = MinimumRangeTo * PCA
'		Else
'			PCAAmt = TotalCum * PCA
'		End If
'	Else
'		PCAAmt = 0
'	End If
'	
'	CurrentAmt = BasicAmt + PCAAmt
'	FranchiseTaxAmt = (CurrentAmt * FranchiseTaxPct)
'
'	If IsSenior = 1 Then
'		SeniorOnBeforeAmt = GetSeniorBefore(ReadID, TotalCum)
'		SeniorAfterAmt = GetSeniorAfter(ReadID, TotalCum)
'	Else
'		SeniorAfterAmt = 0
'		SeniorOnBeforeAmt = 0
'	End If
'	
'	TotalDueAmtBeforeSC = CurrentAmt - SeniorOnBeforeAmt
'	
'	Dim dSeptageAmt As Double
'	
'	If AcctClass = "RES" Then
'		dSeptageAmt = 3
'	else If AcctClass = "COM" Then
'		dSeptageAmt = 7
'	else If AcctClass = "GOV" Then
'		dSeptageAmt = 5
'	End If
'	
'	If HasSeptageFee = 1 Then
'		MinimumRangeTo = DBaseFunctions.GetMinimumRangeTo(GlobalVar.BranchID, AcctClass, AcctSubClass, GlobalVar.BillYear & "-" & GlobalVar.BillMonth & "-01")
'		If TotalCum <= MinimumRangeTo Then
'			SeptageFeeAmt = MinimumRangeTo * dSeptageAmt
'		Else
'			If TotalCum >= MaxSeptageCum Then
'				SeptageFeeAmt = MaxSeptageCum * dSeptageAmt
'			Else
'				SeptageFeeAmt = TotalCum * dSeptageAmt
'			End If
''			SeptageFeeAmt = TotalCum * dSeptageAmt
'		End If
'	Else
'		SeptageFeeAmt = 0
'	End If
''	If ((CurrentAmt + AddToBillAmt + ArrearsAmt) - SeniorOnBeforeAmt) < AdvPayment Then
''		TotalDueAmt = 0
''	Else
''		TotalDueAmt = CurrentAmt + AddToBillAmt + ArrearsAmt - (AdvPayment + SeniorOnBeforeAmt)
''	End If
'
'	If ((CurrentAmt + AddToBillAmt + ArrearsAmt + MeterCharges + FranchiseTaxAmt + SeptageFeeAmt) - SeniorOnBeforeAmt) < AdvPayment Then
'		TotalDueAmt = 0
'	Else
'		TotalDueAmt = CurrentAmt + AddToBillAmt + ArrearsAmt + MeterCharges + FranchiseTaxAmt + SeptageFeeAmt - (AdvPayment + SeniorOnBeforeAmt)
'	End If
'	
'	If AdvPayment > CurrentAmt Then
'		PenaltyAmt = 0
'	Else
'		PenaltyAmt = (CurrentAmt - AdvPayment) * PenaltyPct
'	End If
'	
'	If (CurrentAmt + AddToBillAmt + ArrearsAmt + MeterCharges + FranchiseTaxAmt + SeptageFeeAmt) - SeniorAfterAmt < AdvPayment Then
'		TotalDueAmtAfterSC = 0
'	Else
'		TotalDueAmtAfterSC = CurrentAmt + AddToBillAmt + ArrearsAmt + MeterCharges + FranchiseTaxAmt + SeptageFeeAmt - (AdvPayment + SeniorAfterAmt) + PenaltyAmt
'	End If
'
'	
'	Starter.DBCon.BeginTransaction
'	Try
'		If blnEdit = True Then
'			Starter.strCriteria = "UPDATE tblReadings " & _
'							  "SET PresRdg = ?, PresCum = ?, TotalCum = ?, BillType =?, BasicAmt = ?, PCAAmt = ?, SeptageAmt = ?, " & _
'							  "CurrentAmt = ?, TotalDueAmt = ?, SeniorOnBeforeAmt = ?, SeniorAfterAmt = ?, TotalDueAmtBeforeSC = ?, PenaltyAmt = ?, TotalDueAmtAfterSC = ?, FranchiseTaxAmt = ?, " & _
'							  "PrintStatus = ?, NoPrinted = ?, WasMissCoded = ?, MissCodeID = ?, MissCode = ?, WasImplosive = ?, ImplosiveType = ?, ImpID = ?, FFindings = ?, FWarnings = ?, ReadRemarks = ?, " & _
'							  "ReadRemarks = ?, WasRead = ?, NoInput = ?, TimeRead = ? " & _
'							  "WHERE ReadID = " & iReadID & " " & _
'							  "AND AcctID = " & iAcctID
'		
'			Starter.DBCon.ExecNonQuery2(Starter.strCriteria, Array As String(PresAveRdg, AveCum, TotalCum, $"AB"$, BasicAmt, PCAAmt, SeptageFeeAmt,  _
'							  CurrentAmt, TotalDueAmt, SeniorOnBeforeAmt, SeniorAfterAmt, TotalDueAmtBeforeSC, PenaltyAmt, TotalDueAmtAfterSC, FranchiseTaxAmt, _
'							  PrintStatus, NoPrinted, $"0"$, $"0"$, $""$, $"0"$, ImplosiveType, $"0"$, $"Average Bill"$, sWarning, strReadRemarks, _
'							  sAveRem, $"1"$, NoInput, TimeRead))
'
'			snack.Initialize("",Activity, $"Reading has been successfully updated."$, snack.DURATION_LONG)
'			SetSnackBarBackground(snack, GlobalVar.PriColor)
'			SetSnackBarTextColor(snack, Colors.White)
'			snack.Show
'			blnEdit = False
'		Else
'			NewSeqNo = DBaseFunctions.GetSeqNo(GlobalVar.BookID)
'			Starter.strCriteria = "UPDATE tblReadings " & _
'							  "SET PresRdg = ?, PresCum = ?, TotalCum = ?, BillType =?, BasicAmt = ?, PCAAmt = ?, SeptageAmt = ?, " & _
'							  "CurrentAmt = ?, TotalDueAmt = ?, SeniorOnBeforeAmt = ?, SeniorAfterAmt = ?, TotalDueAmtBeforeSC = ?, PenaltyAmt = ?, TotalDueAmtAfterSC = ?, FranchiseTaxAmt = ?, " & _
'							  "PrintStatus = ?, NoPrinted = ?, WasMissCoded = ?, MissCodeID = ?, MissCode = ?, WasImplosive = ?, ImplosiveType = ?, ImpID = ?, FFindings = ?, FWarnings = ?, ReadRemarks = ?, " & _
'							  "ReadRemarks = ?, WasRead = ?, NewSeqNo = ?, NoInput = ?, TimeRead = ?, DateRead = ? " & _
'							  "WHERE ReadID = " & iReadID & " " & _
'							  "AND AcctID = " & iAcctID
'		
'			Starter.DBCon.ExecNonQuery2(Starter.strCriteria, Array As String(PresAveRdg, AveCum, TotalCum, $"AB"$, BasicAmt, PCAAmt, SeptageFeeAmt,  _
'							  CurrentAmt, TotalDueAmt, SeniorOnBeforeAmt, SeniorAfterAmt, TotalDueAmtBeforeSC, PenaltyAmt, TotalDueAmtAfterSC, FranchiseTaxAmt, _
'							  PrintStatus, NoPrinted, $"0"$, $"0"$, $""$, $"0"$, ImplosiveType, $"0"$, $"Average Bill"$, sWarning, strReadRemarks, _
'							  sAveRem, $"1"$, NewSeqNo, NoInput, TimeRead, DateRead))
'			snack.Initialize("",Activity, $"New Reading has been successfully posted."$, snack.DURATION_LONG)
'			SetSnackBarBackground(snack, GlobalVar.PriColor)
'			SetSnackBarTextColor(snack, Colors.White)
'			snack.Show
'		End If
'		Starter.DBCon.TransactionSuccessful
'	Catch
'		Log(LastException.Message)
'	End Try
'	Starter.DBCon.EndTransaction
'	blnEdit = False
'End Sub

Private Sub SaveAverageBill(iPrintStatus As Int, iReadID As Int, iAcctID As Int)
	Dim lngDateTime As Long
	Dim sFindings, sWarning As String
	Dim MinimumRangeTo As Int
	Dim MaxMinimum As Int
	Dim sAveCum As String
	
	BasicAmt = 0
	lngDateTime = DateTime.Now
	DateTime.TimeFormat = "HH:mm:ss"
	TimeRead = DateTime.Time(lngDateTime)
	DateTime.DateFormat = "MM/dd/yyyy"
	DateRead = DateTime.Date(lngDateTime)
	

	
	ImplosiveType = $"posted"$
	sWarning = $"Average Bill"$
	
	NoInput = NoInput + 1
	WasRead = 1
	
	PrintStatus = iPrintStatus
	
	If PrintStatus = 1 Then
		NoPrinted = NoPrinted + 1
	Else
		NoPrinted = NoPrinted
	End If
	
'	TotalCum = strSF.Val(lblPresCum.Text) + AddCons
	sAveCum = AveCum '10
	
	If IsNumber(sAveCum) = False Then
		TotalCum = DBaseFunctions.GetMinimumRangeTo(GlobalVar.BranchID, AcctClass, AcctSubClass, GlobalVar.BillYear & "-" & GlobalVar.BillMonth & "-01") + AddCons
		PresAveCum = DBaseFunctions.GetMinimumRangeTo(GlobalVar.BranchID, AcctClass, AcctSubClass, GlobalVar.BillYear & "-" & GlobalVar.BillMonth & "-01") + AddCons
		PresAveRdg = PrevRdg + TotalCum
	Else
		If AddCons > 0 Then
			If AddCons >= AveCum Then
				TotalCum = AddCons
				PresAveCum = 0
				PresAveRdg = PrevRdg
			Else
				PresAveCum = AveCum - AddCons
				TotalCum = PresAveCum + AddCons
				PresAveRdg = PrevRdg + PresAveCum
			End If
		Else
			TotalCum = AveCum
			PresAveCum = AveCum
			PresAveRdg = PrevRdg + AveCum
		End If
		
'		TotalCum = 10 + 10
'		TotalCum = AveCum + AddCons
'		PresAveCum = AveCum + AddCons
'		PresAveRdg = PrevRdg + AveCum
	End If
	'****
'	intRateHeaderID = DBaseFunctions.GetRatesHeaderID(AcctClass, AcctSubClass)

	BasicAmt = DBaseFunctions.ComputeBasicAmt(strSF.Val(PresAveCum), GlobalVar.BranchID, AcctClass, AcctSubClass, GlobalVar.BillYear & "-" & GlobalVar.BillMonth & "-01")

	'/////////////// Discount HWRI //////////////////////////////
	'26 (HWRI - Matungao Branch) - All Residential (48.50)
	'27 (HWRI - Bustos Branch) - All Residential (40.00)
	'28 (HWRI - Malis Branch) - All Residential with 0-20 CuM (42.50)
	'29 (HWRI - Agatha Branch) - All Residential with 0-20 CuM (42.50)
	'30 (HWRI - Tuktukan Branch) - All Residential with 0-20 CuM (42.50)
	'36 (HWRI - Paombong Branch) - All Residential (97.00)
	'58 (HWRI - San Francisco Branch)- All Residential (48.50)
	
'	If GlobalVar.BillMonth = 5 And GlobalVar.BillYear = 2020 Then ' May 2020 Bills only
'		If GlobalVar.BranchID = 26 Or GlobalVar.BranchID = 58 Then 'Bulakan
'			If AcctClass = "RES" Then
'				DiscAmt = 48.50
'			Else
'				DiscAmt = 0
'			End If
'		End If
'		If GlobalVar.BranchID = 27 Then 'Bustos
'			If AcctClass = "RES" Then
'				DiscAmt = 40.00
'			Else
'				DiscAmt = 0
'			End If
'		End If
'		If GlobalVar.BranchID = 28 Or GlobalVar.BranchID = 29 Or GlobalVar.BranchID = 30 Then ' Guiguinto
'			If AcctClass = "RES" Then
'				If TotalCum <= 20 Then
'					DiscAmt = 42.50
'				Else
'					DiscAmt = 0
'				End If
'			Else
'				DiscAmt = 0
'			End If
'		End If
'		If GlobalVar.BranchID = 36 Then 'Paombong
'			If AcctClass = "RES" Then
'				DiscAmt = 97.00
'			Else
'				DiscAmt = 0
'			End If
'		End If
'		If GlobalVar.BranchID = 67 Then 'Villa Louise
'			DiscAmt = 48.25
'		End If
'	Else
'		DiscAmt = 0
'	End If

'	If GlobalVar.BranchID = 25 And GlobalVar.BillYear = 2020 And GlobalVar.BillMonth = 4 Then 'Balagtas Branch ID
'		If AcctClass = "RES" Then
'			'Get the Rate Header ID depends on subclass
'			intRateHeaderID = DBaseFunctions.GetRatesResHeaderID(AcctSubClass)
'			'Get the Minimum amount of RES(AcctSubClass) Rate and multiply it by 50%
'			DiscAmt = DBaseFunctions.GetMinimumRate(intRateHeaderID) * 0.5
'		Else
'			DiscAmt = 0
'		End If
'	Else
'		DiscAmt = 0
'	End If
	'///////////////////////////////////////////////////////////////////////////////////////////////////////
	
	If DBaseFunctions.IsBookWithPCA(GlobalVar.BookID) = True Then
		MinimumRangeTo = DBaseFunctions.GetMinimumRangeTo(GlobalVar.BranchID, AcctClass, AcctSubClass, GlobalVar.BillYear & "-" & GlobalVar.BillMonth & "-01")
		If TotalCum <= MinimumRangeTo Then
			PCAAmt = MinimumRangeTo * PCA
		Else
			PCAAmt = TotalCum * PCA
		End If
	Else
		PCAAmt = 0
	End If
	
	CurrentAmt = (BasicAmt + PCAAmt)
	FranchiseTaxAmt = (CurrentAmt * FranchiseTaxPct)

	If IsSenior = 1 Then
		SeniorOnBeforeAmt = GetSeniorBefore(ReadID, TotalCum)
		SeniorAfterAmt = GetSeniorAfter(ReadID, TotalCum)
	Else
		SeniorAfterAmt = 0
		SeniorOnBeforeAmt = 0
	End If
	
	'Discount for the Month of June 2020
	If GlobalVar.BillYear = 2020 And GlobalVar.BillMonth = 6 Then
		If GlobalVar.BranchID = 59 Then 'Salintubig
			DiscAmt = (CurrentAmt * 0.5) + 48.25
		Else If GlobalVar.BranchID = 67 Then 'Louise
			DiscAmt = (CurrentAmt * 0.5)
		Else
			DiscAmt = 0
		End If
	Else
		DiscAmt = 0
	End If

	TotalDueAmtBeforeSC = CurrentAmt - SeniorOnBeforeAmt - DiscAmt
	
	Dim dSeptageAmt As Double
	
	If AcctClass = "RES" Then
		dSeptageAmt = 3
	else If AcctClass = "COM" Then
		dSeptageAmt = 7
	else If AcctClass = "GOV" Then
		dSeptageAmt = 5
	End If
	
	If HasSeptageFee = 1 Then
		MinimumRangeTo = DBaseFunctions.GetMinimumRangeTo(GlobalVar.BranchID, AcctClass, AcctSubClass, GlobalVar.BillYear & "-" & GlobalVar.BillMonth & "-01")
		If TotalCum <= MinimumRangeTo Then
			SeptageFeeAmt = MinimumRangeTo * dSeptageAmt
		Else
			If TotalCum >= MaxSeptageCum Then
				SeptageFeeAmt = MaxSeptageCum * dSeptageAmt
			Else
				SeptageFeeAmt = TotalCum * dSeptageAmt
			End If
'			SeptageFeeAmt = TotalCum * dSeptageAmt
		End If
	Else
		SeptageFeeAmt = 0
	End If
	
'	If ((CurrentAmt + AddToBillAmt + ArrearsAmt) - SeniorOnBeforeAmt) < AdvPayment Then
'		TotalDueAmt = 0
'	Else
'		TotalDueAmt = CurrentAmt + AddToBillAmt + ArrearsAmt - (AdvPayment + SeniorOnBeforeAmt)
'	End If

	If ((CurrentAmt + AddToBillAmt + ArrearsAmt + MeterCharges + FranchiseTaxAmt + SeptageFeeAmt) - (SeniorOnBeforeAmt + DiscAmt)) < AdvPayment Then
		TotalDueAmt = 0
	Else
		TotalDueAmt = CurrentAmt + AddToBillAmt + ArrearsAmt + MeterCharges + FranchiseTaxAmt + SeptageFeeAmt - (AdvPayment + SeniorOnBeforeAmt + DiscAmt)
	End If
	
	If AdvPayment > CurrentAmt Then
		PenaltyAmt = 0
	Else
		PenaltyAmt = (CurrentAmt - AdvPayment) * PenaltyPct
	End If
	
	If ((CurrentAmt + AddToBillAmt + ArrearsAmt + MeterCharges + FranchiseTaxAmt + SeptageFeeAmt) - (SeniorAfterAmt + DiscAmt)) < AdvPayment Then
		TotalDueAmtAfterSC = 0
	Else
		TotalDueAmtAfterSC = CurrentAmt + AddToBillAmt + ArrearsAmt + MeterCharges + FranchiseTaxAmt + SeptageFeeAmt - (AdvPayment + SeniorAfterAmt + DiscAmt) + PenaltyAmt
	End If

'	sAveRem = "Avg. Bill due to ECQ"
	
	Starter.DBCon.BeginTransaction
	Try
		If blnEdit = True Then
			Starter.strCriteria = "UPDATE tblReadings " & _
							  "SET PresRdg = ?, PresCum = ?, TotalCum = ?, BillType =?, BasicAmt = ?, PCAAmt = ?, SeptageAmt = ?, " & _
							  "CurrentAmt = ?, TotalDueAmt = ?, SeniorOnBeforeAmt = ?, SeniorAfterAmt = ?, TotalDueAmtBeforeSC = ?, PenaltyAmt = ?, TotalDueAmtAfterSC = ?, DiscAmt = ?, FranchiseTaxAmt = ?, " & _
							  "PrintStatus = ?, NoPrinted = ?, WasMissCoded = ?, MissCodeID = ?, MissCode = ?, WasImplosive = ?, ImplosiveType = ?, ImpID = ?, FFindings = ?, FWarnings = ?, ReadRemarks = ?, " & _
							  "ReadRemarks = ?, WasRead = ?, NoInput = ?, TimeRead = ? " & _
							  "WHERE ReadID = " & iReadID & " " & _
							  "AND AcctID = " & iAcctID
		
			Starter.DBCon.ExecNonQuery2(Starter.strCriteria, Array As String(PresAveRdg, PresAveCum, TotalCum, $"AB"$, BasicAmt, PCAAmt, SeptageFeeAmt,  _
							  CurrentAmt, TotalDueAmt, SeniorOnBeforeAmt, SeniorAfterAmt, TotalDueAmtBeforeSC, PenaltyAmt, TotalDueAmtAfterSC, DiscAmt, FranchiseTaxAmt, _
							  PrintStatus, NoPrinted, $"0"$, $"0"$, $""$, $"0"$, ImplosiveType, $"0"$, $"Average Bill"$, sWarning, strReadRemarks, _
							  sAveRem, $"1"$, NoInput, TimeRead))

			snack.Initialize("",Activity, $"Reading has been successfully updated."$, snack.DURATION_LONG)
			SetSnackBarBackground(snack, GlobalVar.PriColor)
			SetSnackBarTextColor(snack, Colors.White)
			snack.Show
			blnEdit = False
		Else
			NewSeqNo = DBaseFunctions.GetSeqNo(GlobalVar.BookID)
			Starter.strCriteria = "UPDATE tblReadings " & _
							  "SET PresRdg = ?, PresCum = ?, TotalCum = ?, BillType =?, BasicAmt = ?, PCAAmt = ?, SeptageAmt = ?, " & _
							  "CurrentAmt = ?, TotalDueAmt = ?, SeniorOnBeforeAmt = ?, SeniorAfterAmt = ?, TotalDueAmtBeforeSC = ?, PenaltyAmt = ?, TotalDueAmtAfterSC = ?, DiscAmt = ?, FranchiseTaxAmt = ?, " & _
							  "PrintStatus = ?, NoPrinted = ?, WasMissCoded = ?, MissCodeID = ?, MissCode = ?, WasImplosive = ?, ImplosiveType = ?, ImpID = ?, FFindings = ?, FWarnings = ?, ReadRemarks = ?, " & _
							  "ReadRemarks = ?, WasRead = ?, NewSeqNo = ?, NoInput = ?, TimeRead = ?, DateRead = ? " & _
							  "WHERE ReadID = " & iReadID & " " & _
							  "AND AcctID = " & iAcctID
		
			Starter.DBCon.ExecNonQuery2(Starter.strCriteria, Array As String(PresAveRdg, PresAveCum, TotalCum, $"AB"$, BasicAmt, PCAAmt, SeptageFeeAmt,  _
							  CurrentAmt, TotalDueAmt, SeniorOnBeforeAmt, SeniorAfterAmt, TotalDueAmtBeforeSC, PenaltyAmt, TotalDueAmtAfterSC, DiscAmt, FranchiseTaxAmt, _
							  PrintStatus, NoPrinted, $"0"$, $"0"$, $""$, $"0"$, ImplosiveType, $"0"$, $"Average Bill"$, sWarning, strReadRemarks, _
							  sAveRem, $"1"$, NewSeqNo, NoInput, TimeRead, DateRead))
			snack.Initialize("",Activity, $"New Reading has been successfully posted."$, snack.DURATION_LONG)
			SetSnackBarBackground(snack, GlobalVar.PriColor)
			SetSnackBarTextColor(snack, Colors.White)
			snack.Show
		End If
		Starter.DBCon.TransactionSuccessful
	Catch
		Log(LastException.Message)
	End Try
	Starter.DBCon.EndTransaction
	blnEdit = False
End Sub

Private Sub UpdatePrintStatus(iReadID As Int, iAcctID As Int)
	Starter.DBCon.BeginTransaction
	Try
		Starter.strCriteria = "UPDATE tblReadings " & _
							  "SET PrintStatus = ? " & _
							  "WHERE ReadID = " & iReadID & " " & _
							  "AND AcctID = " & iAcctID
		Starter.DBCon.ExecNonQuery2(Starter.strCriteria, Array As String(1))
		Starter.DBCon.TransactionSuccessful
	Catch
		Log(LastException.Message)
	End Try
	Starter.DBCon.EndTransaction
End Sub

Private Sub GetImplosiveType(iPrevCum As Int, iPresCum As Int) As String
	Dim sRetVal As String
	Try
		If iPresCum = 0 Then
			sRetVal = "zero"
		Else If iPresCum < 0 Then
			sRetVal = "negative"
		Else If (iPresCum - iPrevCum) >= 20 Then
			sRetVal = "implosive-inc"
		Else If (iPrevCum - iPresCum) >= 20 Then
			sRetVal = "implosive-dec"
		Else
			sRetVal = "posted"
		End If
	Catch
		ToastMessageShow($"Unable to get Implosive Type due to "$ & LastException.Message, False)
		Log(LastException)
	End Try
	Return sRetVal
End Sub

Private Sub GetWarning(iPrevCum As Int, iPresCum As Int) As String
	Dim sRetVal As String
	Try
		If iPresCum = 0 Then
			sRetVal = "Zero Consumption"
		Else If iPresCum < 0 Then
			sRetVal = "Negative Consumption"
		Else If (iPresCum - iPrevCum) >= 20 Then
			sRetVal = "High Bill"
		Else If (iPrevCum - iPresCum) >= 20 Then
			sRetVal = "Low Bill"
		Else
			sRetVal = "NONE"
		End If
	Catch
		ToastMessageShow($"Unable to get Implosive Type due to "$ & LastException.Message, False)
		Log(LastException)
	End Try
	Return sRetVal
End Sub

#End Region

#Region Computation

Sub ComputeCumUsed() As Long
	Dim RetVal As Long
	If Not(IsNumber(txtPresRdg.Text)) Or txtPresRdg.Text.Length<=0 Then
		RetVal= 0
	Else
		RetVal=strSF.Val(txtPresRdg.Text) - PrevRdg
	End If
	Return RetVal
End Sub

Private Sub GetSeniorBefore(iReadID As Int, dTotCum As Double) As Double
	Dim rsSCBefore As Cursor

	Dim dBillAmt As Double
	Dim dMaxCum As Double
	Dim fPct As Double
	Dim RetSeniorDiscount As Double
	Dim maxPCAAmount = 0 As Double
	
	Try
		Starter.strCriteria = "SELECT * FROM tblReadings " & _
							  "WHERE ReadID = " & iReadID
		
		rsSCBefore = Starter.DBCon.ExecQuery(Starter.strCriteria)
		If rsSCBefore.RowCount > 0 Then
			rsSCBefore.Position = 0
			fPct = rsSCBefore.GetDouble("SeniorOnBefore")
			dMaxCum = rsSCBefore.GetDouble("SeniorMaxCum")
			
			maxPCAAmount = dMaxCum * PCA
			
			If PCAAmt > maxPCAAmount Then
				dBillAmt = (DBaseFunctions.ComputeBasicAmt(dMaxCum, GlobalVar.BranchID, AcctClass, AcctSubClass, GlobalVar.BillYear & "-" & GlobalVar.BillMonth & "-01")) + maxPCAAmount
			Else If PCAAmt = 0 Then
				If TotalCum > dMaxCum Then
					dBillAmt = (DBaseFunctions.ComputeBasicAmt(dMaxCum, GlobalVar.BranchID, AcctClass, AcctSubClass, GlobalVar.BillYear & "-" & GlobalVar.BillMonth & "-01"))
				Else
					dBillAmt = CurrentAmt
				End If
			Else
				dBillAmt = CurrentAmt
			End If
			RetSeniorDiscount = dBillAmt * fPct
		End If
	Catch
		ToastMessageShow($"Unable to get Senior Discount Before Due Date due to "$ & LastException.Message, False)
		Log(LastException.Message)
	End Try
	rsSCBefore.Close
	Return RetSeniorDiscount
End Sub

Private Sub GetSeniorAfter(iReadID As Int, dTotCum As Double) As Double
	Dim rsSCAfter As Cursor
	
	Dim dBillAmt As Double
	Dim dMaxCum As Double
	Dim fPct As Double
	Dim RetSeniorDiscount As Double
	Dim maxPCAAmount = 0 As Double
	Try
		Starter.strCriteria = "SELECT * FROM tblReadings " & _
							  "WHERE ReadID = " & iReadID
		
		rsSCAfter = Starter.DBCon.ExecQuery(Starter.strCriteria)
		If rsSCAfter.RowCount > 0 Then
			rsSCAfter.Position=0
			fPct = rsSCAfter.GetDouble("SeniorAfter")
			dMaxCum = rsSCAfter.GetDouble("SeniorMaxCum")
		
			maxPCAAmount = dMaxCum * PCA
			
			If PCAAmt > maxPCAAmount Then
				dBillAmt = (DBaseFunctions.ComputeBasicAmt(dMaxCum, GlobalVar.BranchID, AcctClass, AcctSubClass, GlobalVar.BillYear & "-" & GlobalVar.BillMonth & "-01")) + maxPCAAmount
			Else If PCAAmt = 0 Then
				If TotalCum > dMaxCum Then
					dBillAmt = (DBaseFunctions.ComputeBasicAmt(dMaxCum, GlobalVar.BranchID, AcctClass, AcctSubClass, GlobalVar.BillYear & "-" & GlobalVar.BillMonth & "-01"))
				Else
					dBillAmt = CurrentAmt
				End If
			Else
				dBillAmt = CurrentAmt
			End If
			RetSeniorDiscount = dBillAmt * fPct
		End If
	Catch
		ToastMessageShow($"Unable to get Senior Discount After Due Date due to "$ & LastException.Message, False)
	End Try
	rsSCAfter.Close
	Return RetSeniorDiscount
End Sub

#End Region

#Region Negative Consumption
Private Sub ShowNegativeReadingDialog
	Dim csTitle As CSBuilder
	Dim csContent As CSBuilder
	
	csTitle.Initialize.Color(Colors.Red).Size(16).Bold.Append($"WARNING! NEGATIVE CONSUMPTION POSTING"$).PopAll
	csContent.Initialize.Bold.Color(Colors.Red).Size(14).Append(CRLF & $"Ooops! It looks like Customer Meter Reading Went Back."$).Pop.Pop
	csContent.Color(Colors.DarkGray).Append(CRLF & $"Miss Code Entry Required."$).Pop.Pop.Color(GlobalVar.PriColor).Append(CRLF & CRLF & $"Please select a code from the list..."$).PopAll
	
'	MatDialogBuilder.Initialize("AddNewMissCode")
'	MatDialogBuilder.Theme(MatDialogBuilder.THEME_LIGHT)
'	MatDialogBuilder.Title(csTitle).TitleColor(Colors.Red).TitleGravity(MatDialogBuilder.GRAVITY_START)
'	MatDialogBuilder.IconRes(GlobalVar.WarningIcon).LimitIconToDefaultSize
'	MatDialogBuilder.Content(csContent)
'	MatDialogBuilder.Items(Array As String("Biting Dog", "Meter/Gate Locked", "Meter Not Found", "Hard to Read", "No Entry", "Meter Flooded", "Meter Removed", "Deffective Meter", "Others"))
'	MatDialogBuilder.ItemsCallbackSingleChoice(8)
'	MatDialogBuilder.PositiveText($"SELECT"$).PositiveColor(GlobalVar.PriColor)
'	MatDialogBuilder.NegativeText($"CANCEL"$).NegativeColor(Colors.Red)
'	MatDialogBuilder.CanceledOnTouchOutside(False)
'	MatDialogBuilder.Show
	
	MatDialogBuilder.Initialize("PostNegativeReading")
	MatDialogBuilder.Theme(MatDialogBuilder.THEME_LIGHT)
	MatDialogBuilder.Title(csTitle).TitleGravity(MatDialogBuilder.GRAVITY_START)
	MatDialogBuilder.IconRes(GlobalVar.WarningIcon).LimitIconToDefaultSize
	MatDialogBuilder.Content(csContent)
	MatDialogBuilder.Items(Array As String("Biting Dog", "Meter/Gate Locked", "Meter Not Found", "Hard to Read", "No Entry", "Meter Flooded", "Meter Removed", "Deffective Meter", "Others"))
	MatDialogBuilder.ItemsCallbackSingleChoice(8)
	MatDialogBuilder.PositiveText($"SAVE"$).PositiveColor(GlobalVar.PriColor)
	MatDialogBuilder.NegativeText($"CANCEL"$).NegativeColor(Colors.Red)
	MatDialogBuilder.CanceledOnTouchOutside(False)
	MatDialogBuilder.Show
End Sub

Sub PostNegativeReading_SingleChoiceItemSelected (mDialog As MaterialDialog, iPosition As Int, sDesc As String)
	MissCodeID = iPosition + 1
	MissCode = sDesc
End Sub

Sub PostNegativeReading_ButtonPressed (mDialog As MaterialDialog, sAction As String)
	Select Case sAction
		Case mDialog.ACTION_POSITIVE
			vibration.vibrateCancel
			Select Case MissCodeID
				Case 9
					ShowAddOtherMissCodeDialog
				Case Else
					'Save Miss Code
					intCurrPos = rsLoadedBook.Position
					SaveMissCodeOnly(MissCodeID, MissCode, ReadID, AcctID)
					If RetrieveRecords(GlobalVar.BookID)=False Then Return
					If intCurrPos < (RecCount - 1) Then
						rsLoadedBook.Position = intCurrPos + 1
					Else
						rsLoadedBook.Position = intCurrPos
					End If
					DisplayRecord
					ButtonState
					If GetUnusualCount(GlobalVar.BookID) = True Then
						UpdateBadge("Flag", AddBadgeToIcon(flagBitmap, intTotal))
					End If
			End Select
			
		Case mDialog.ACTION_NEGATIVE
			snack.Initialize("", Activity, $"Adding Miss Code entry cancelled."$ ,snack.DURATION_SHORT)
			SetSnackBarBackground(snack, Colors.White)
			SetSnackBarTextColor(snack, Colors.Red)
			snack.Show
			vibration.vibrateCancel
			rsLoadedBook.Position= intCurrPos
			DisplayRecord
			ButtonState
			Return
	End Select
End Sub

#End Region

#Region Zero Consumption
Private Sub ShowSaveZeroReadingDialog
	Dim csContent As CSBuilder

	csContent.Initialize.Size(14).Color(Colors.Red).Bold.Append($"WARNING! ZERO CONSUMPTION DETECTED!"$).Color(Colors.DarkGray).Append(CRLF & $"Remarks required. Please enter a Remarks for this Reading."$).PopAll
	
	MatDialogBuilder.Initialize("PostZeroReading")
	MatDialogBuilder.Theme(MatDialogBuilder.THEME_LIGHT)
	MatDialogBuilder.Title($"ZERO CONSUMPTION POSTING"$).TitleColor(Colors.Red).TitleGravity(MatDialogBuilder.GRAVITY_START)
	MatDialogBuilder.IconRes(GlobalVar.WarningIcon).LimitIconToDefaultSize
	MatDialogBuilder.InputType(Bit.Or(Bit.Or(MatDialogBuilder.TYPE_CLASS_TEXT, MatDialogBuilder.TYPE_TEXT_FLAG_CAP_SENTENCES), MatDialogBuilder.TYPE_TEXT_VARIATION_PERSON_NAME))
	MatDialogBuilder.Input2($"Type your Remarks here..."$, $"Zero Consumption."$, False)
	MatDialogBuilder.AlwaysCallInputCallback
	MatDialogBuilder.Content(csContent)
	MatDialogBuilder.ContentColor(Colors.Black)
	MatDialogBuilder.PositiveText($"SAVE AND PRINT"$).PositiveColor(GlobalVar.PriColor)
	MatDialogBuilder.NegativeText($"SAVE ONLY"$).NegativeColor(Colors.Black)
	MatDialogBuilder.NeutralText($"CANCEL POSTING"$).NeutralColor(Colors.Red)
	MatDialogBuilder.CanceledOnTouchOutside(False)
	MatDialogBuilder.Show
End Sub

Private Sub PostZeroReading_InputChanged (mDialog As MaterialDialog, sRemarks As String)
	If sRemarks.Length = 0 Then
		mDialog.EnableActionButton(mDialog.ACTION_NEGATIVE, False)
		mDialog.EnableActionButton(mDialog.ACTION_POSITIVE, False)
	Else
		mDialog.EnableActionButton(mDialog.ACTION_NEGATIVE, True)
		mDialog.EnableActionButton(mDialog.ACTION_POSITIVE, True)
	End If
	strReadRemarks = sRemarks
End Sub

Sub PostZeroReading_ButtonPressed (Dialog As MaterialDialog, Action As String)
	Select Case Action
		Case Dialog.ACTION_POSITIVE
			intCurrPos = rsLoadedBook.Position
			SaveReading(1, ReadID, AcctID)
			PrintBillData(ReadID)
			If RetrieveRecords(GlobalVar.BookID)=False Then Return
			If intCurrPos < (RecCount - 1) Then
				rsLoadedBook.Position = intCurrPos + 1
			Else
				rsLoadedBook.Position = intCurrPos
			End If
			DisplayRecord
			ButtonState
			If GetUnusualCount(GlobalVar.BookID) = True Then
				UpdateBadge("Flag", AddBadgeToIcon(flagBitmap, intTotal))
			End If
			vibration.vibrateCancel
		Case Dialog.ACTION_NEGATIVE
			SaveReading(0, ReadID, AcctID)
			If RetrieveRecords(GlobalVar.BookID)=False Then Return
			If intCurrPos < (RecCount - 1) Then
				rsLoadedBook.Position = intCurrPos + 1
			Else
				rsLoadedBook.Position = intCurrPos
			End If
			DisplayRecord
			ButtonState
			If GetUnusualCount(GlobalVar.BookID) = True Then
				UpdateBadge("Flag", AddBadgeToIcon(flagBitmap, intTotal))
			End If
			vibration.vibrateCancel
		Case Dialog.ACTION_NEUTRAL
			snack.Initialize("", Activity, $"Adding Reading Remarks Cancelled."$ ,snack.DURATION_SHORT)
			SetSnackBarBackground(snack, Colors.White)
			SetSnackBarTextColor(snack, Colors.Red)
			snack.Show
			vibration.vibrateCancel
			rsLoadedBook.Position= intCurrPos
			DisplayRecord
			ButtonState
			Return
	End Select
End Sub
#End Region

#Region Printing
Private Sub PrintBillData(iReadID As Int)
	Dim rsData As Cursor
	Dim sDisconDate As String
	Dim dDisconDate As Long

'	DateTime.DateFormat = "MM/dd/yyyy"
	' Hiyas
'	sDisconDate = DateTime.GetMonth(DateTime.Now) & "/20/" & DateTime.GetYear(DateTime.Now)
'	sDisconDate = dDisconDate
	ProgressDialogShow2($"Bill Statement Printing..."$, False)

	Try
		Starter.strCriteria = "SELECT * FROM tblReadings WHERE ReadID = " & iReadID & " " & _
							  "AND BookID = " & GlobalVar.BookID & " " & _
							  "AND BillYear = " & GlobalVar.BillYear & " " & _
							  "AND BillMonth = " & GlobalVar.BillMonth
		rsData = Starter.DBCon.ExecQuery(Starter.strCriteria)

		If rsData.RowCount > 0 Then
			rsData.Position = 0
			AcctNo = rsData.GetString("AcctNo")
			AcctName = rsData.GetString("AcctName")
			AcctAddress = rsData.GetString("AcctAddress")
			AcctStatus = rsData.GetString("AcctStatus")
			
			MeterNo = rsData.GetString("MeterNo")
			BookID = rsData.GetInt("BookID")
			BookSeq = rsData.GetString("BookNo") & "-" & rsData.GetString("SeqNo")
			CustClass = rsData.GetString("AcctClass") & "-" & rsData.GetString("AcctSubClass")
			GDeposit = Round2(rsData.GetDouble("GDeposit"),2)
			BillNo = rsData.GetString("BillNo")
			BillDate = rsData.GetString("DateRead")
			

			PresRdg = rsData.GetInt("PresRdg")
			PrevRdg = rsData.GetInt("PrevRdg")
			AddCons = rsData.GetInt("AddCons")
			TotalCum = rsData.GetInt("TotalCum")

			BasicAmt =Round2(rsData.GetDouble("BasicAmt"),2)
			PCAAmt = Round2(rsData.GetDouble("PCAAmt"),2)
			CurrentAmt = Round2(rsData.GetDouble("CurrentAmt"),2)
			SeniorOnBeforeAmt = Round2(rsData.GetDouble("SeniorOnBeforeAmt"),2)
			AddToBillAmt = Round2(rsData.GetDouble("AddToBillAmt"),2)'Others
			MeterCharges = Round2(rsData.GetDouble("MeterCharges"), 2)
			FranchiseTaxAmt = Round2(rsData.GetDouble("FranchiseTaxAmt"), 2)
			SeptageFeeAmt = Round2(rsData.GetDouble("SeptageAmt"), 2)
			ArrearsAmt = Round2(rsData.GetDouble("ArrearsAmt"), 2)
			AdvPayment = Round2(rsData.GetDouble("AdvPayment"), 2)
			TotalDueAmt = Round2(rsData.GetDouble("TotalDueAmt"), 2)
			iHasSeptage = rsData.GetInt("HasSeptageFee")
			
			WithDueDate = rsData.GetInt("WithDueDate")
'			//apalit only
'			If WithDueDate = 1 Then
'				DueDate = rsData.GetString("DueDate")
'			Else
'				DueDate = ""
'			End If
			
			PenaltyAmt = Round2(rsData.GetDouble("PenaltyAmt"), 2)
			SeniorAfterAmt = Round2(rsData.GetDouble("SeniorAfterAmt"), 2)
			TotalDueAmtAfterSC = Round2(rsData.GetDouble("TotalDueAmtAfterSC"), 2)
			DiscAmt2 = Round2(rsData.GetDouble("DiscAmt"), 2)

			'//////////////////////////////////////////////////////////////////////////////////////////////////////
'			If AcctStatus = "dc" Then
'				DateFrom = rsData.GetString("DateFrom")
'				DateTo = rsData.GetString("DisconDate")
'			Else
'				DateFrom = rsData.GetString("DateFrom")
'				DateTo = rsData.GetString("DateRead")
'			End If
			'//////////////////////////////////////////////////////////////////////////////////////////////////////

'			If AcctStatus = "dc" Then
'				DateFrom = rsData.GetString("DateFrom")
'				DateTo = rsData.GetString("DisconDate")
'			Else

			DateFrom = rsData.GetString("DateFrom")
			DateTo = rsData.GetString("DateRead")
			BillPeriod1st = rsData.GetString("BillPeriod1st")
			BillPeriod2nd = rsData.GetString("BillPeriod2nd")
			BillPeriod3rd = rsData.GetString("BillPeriod3rd")
			PrevCum1st = rsData.GetInt("PrevCum1st")
			PrevCum2nd = rsData.GetInt("PrevCum2nd")
			PrevCum3rd = rsData.GetInt("PrevCum3rd")
			DisconnectionDate = rsData.GetString("DisconnectionDate")
'			End If
			
		End If
		
		If GlobalVar.BranchID = 42 Or GlobalVar.BranchID = 48 Then 'Capas and Tela
			sBranchName = $"BWSI - CLPI"$ & CRLF & $"BRANCHES INC."$
		Else
			sBranchName = strSF.Right(GlobalVar.BranchName, GlobalVar.BranchName.Length - 7)
		End If
		
		If GlobalVar.BranchID = 28 Or GlobalVar.BranchID = 29 Or  GlobalVar.BranchID = 30 Then
			sBranchAddress = GlobalVar.BranchAddress & CRLF & Chr(27) & "!" & Chr(1) & "Guiguinto, Bulacan"
		Else If GlobalVar.BranchID = 67  Then
			sBranchAddress = GlobalVar.BranchAddress & CRLF & Chr(27) & "!" & Chr(1) & "Pandi, Bulacan"
		Else
			sBranchAddress = GlobalVar.BranchAddress
		End If

		sBranchContactNo = GlobalVar.BranchContactNo
		sTinNo = GlobalVar.BranchTINumber
		sBranchCode = GlobalVar.BranchCode
		sBillPeriod = GlobalVar.BillPeriod
		
		'to String
		sPresRdg = PresRdg
		sPrevRdg = PrevRdg
		sAddCons = AddCons
		sTotalCum = TotalCum

		sGDeposit = GDeposit
		sBasicAmt = BasicAmt
		sPCAAmt = PCAAmt
		sCurrentAmt = CurrentAmt
		sDiscAmt = DiscAmt2
		sSeniorOnBeforeAmt = SeniorOnBeforeAmt
		sAddToBillAmt = AddToBillAmt'Others
		sArrearsAmt = ArrearsAmt
		sAdvPayment = AdvPayment
		sTotalDueAmt = TotalDueAmt
		sPenaltyAmt = PenaltyAmt
		sSeniorAfterAmt = SeniorAfterAmt
		sTotalDueAmtAfterSC = TotalDueAmtAfterSC
		sMeterCharges = MeterCharges
		sFranchiseTaxAmt = FranchiseTaxAmt
		sSeptageFeeAmt = SeptageFeeAmt

'		& Chr(27) & "!" & Chr(1) & "Guiguinto, Bulacan" & Chr(10) _
		PrintBuffer = Chr(27) & "@" _
					& Chr(27) & Chr(97) & Chr(49) _
					& Chr(27) & "!" & Chr(33) & sBranchName & Chr(10) _
					& Chr(27) & "!" & Chr(1) & Chr(27) & "t" & Chr(14) & sBranchAddress & Chr(10) _
					& Chr(27) & "!" & Chr(1) & sBranchContactNo & Chr(10) _
					& Chr(27) & "!" & Chr(1) & "TIN NO: " & sTinNo & Chr(10) _
					& Chr(27) & "!" & Chr(8) & "Branch Code: " & sBranchCode & CRLF & Chr(10) _
					& Chr(27) & "!" & Chr(33) & "STATEMENT OF ACCOUNT" & Chr(10) _
					& Chr(27) & "!" & Chr(1) & "For the Month of " & sBillPeriod & Chr(10) _
					& Chr(27) & "!" & Chr(1) & "------------------------------------------" & Chr(10) _
					& Chr(27) & Chr(97) & Chr(48) _
					& Chr(27) & "!" & Chr(16) & "Account No: " & AcctNo  & Chr(10) _
					& Chr(27) & "!" & Chr(16) & Chr(27) & "t" & Chr(16) & strSF.Upper(AcctName) & Chr(10) _
					& Chr(27) & "!" & Chr(1) & Chr(27) & "t" & Chr(16) & strSF.Left(strSF.Proper(AcctAddress),42) & Chr(10) _
					& Chr(27) & "!" & Chr(16) & "Meter No: " & MeterNo &  Chr(10) _
					& Chr(27) & "!" & Chr(8) & "Book-Seq: " & BookSeq &  Chr(10) _
					& Chr(27) & "!" & Chr(0) & "Class   : " & CustClass &  Chr(10) _
					& "Guarantee Deposit " & AddWhiteSpaces2(NumberFormat2(sGDeposit,1,2,2,True)) & NumberFormat2(sGDeposit,1,2,2,True) &  Chr(10) _
					& Chr(27) & "!" & Chr(1) & "------------------------------------------" & Chr(10) _
					& Chr(27) & "!" & Chr(8) & "Bill Number       " & AddWhiteSpaces2(BillNo) & BillNo  &  Chr(10) _
					& Chr(27) & "!" & Chr(0) & "Bill Date         " & AddWhiteSpaces2(BillDate) & BillDate  &  Chr(10) _
					& "Period From       " & AddWhiteSpaces2(DateFrom) & DateFrom  &  Chr(10) _
					& "Period To         " & AddWhiteSpaces2(DateTo) & DateTo  &  Chr(10) _
					& Chr(27) & "!" & Chr(1) & "------------------------------------------" & Chr(10) _
					& Chr(27) & "!" & Chr(0) & "Pres. Reading      " & AddWhiteSpaces(sPresRdg) & sPresRdg &  Chr(10) _
					& Chr(27) & "!" & Chr(0) & "Prev. Reading      " & AddWhiteSpaces(sPrevRdg) & sPrevRdg &  Chr(10) _
					& Chr(27) & "!" & Chr(0) & "Add Cons.          " & AddWhiteSpaces(sAddCons) & sAddCons & Chr(10) _
					& Chr(27) & "!" & Chr(0) & "Total Cum          " & AddWhiteSpaces(sTotalCum) & sTotalCum  & Chr(10) _
					& Chr(27) & "!" & Chr(1) & "------------------------------------------" & Chr(10) _
					& Chr(27) & "!" & Chr(0) & "BASIC              " & AddWhiteSpaces(NumberFormat2(sBasicAmt,1, 2, 2,True)) & NumberFormat2(sBasicAmt,1, 2, 2,True) &  Chr(10) _
					& Chr(27) & "!" & Chr(0) & "PCA                " & AddWhiteSpaces(NumberFormat2(sPCAAmt,1, 2, 2,True)) & NumberFormat2(sPCAAmt,1, 2, 2,True) &  Chr(10) _
					& Chr(27) & "!" & Chr(16) & "CURRENT BILL       " & AddWhiteSpaces(NumberFormat2(sCurrentAmt,1, 2, 2,True)) & NumberFormat2(sCurrentAmt,1, 2, 2,True) &  Chr(10) _
					& Chr(27) & "!" & Chr(0) & "SR. CITIZEN DISC.  " & AddWhiteSpaces("(" & NumberFormat2(sSeniorOnBeforeAmt,1, 2, 2,True) & ")") & "(" & NumberFormat2(sSeniorOnBeforeAmt,1, 2, 2,True) & ")" &  Chr(10)					

		If DiscAmt2 > 0 Then
			PrintBuffer = PrintBuffer & Chr(27) & "!" & Chr(0) & "DISCOUNT           " & AddWhiteSpaces("(" & NumberFormat2(sDiscAmt,1, 2, 2,True) & ")") & "(" & NumberFormat2(sDiscAmt,1, 2, 2,True) & ")" &  Chr(10)
		End If
		
		PrintBuffer = PrintBuffer & Chr(27) & "!" & Chr(0) & "OTHERS             " & AddWhiteSpaces(NumberFormat2(sAddToBillAmt,1, 2, 2,True)) & NumberFormat2(sAddToBillAmt,1, 2, 2,True) &  Chr(10)

		If GlobalVar.WithMeterCharges = 1 Then
			PrintBuffer = PrintBuffer & "METER CHARGES      " & AddWhiteSpaces(NumberFormat2(sMeterCharges,1, 2, 2,True)) & NumberFormat2(sMeterCharges,1, 2, 2,True) &  Chr(10)
		End If

		If GlobalVar.WithFranchisedTax = 1 Then
			PrintBuffer = PrintBuffer & "FRANCHISE TAX      " & AddWhiteSpaces(NumberFormat2(sFranchiseTaxAmt,1, 2, 2,True)) & NumberFormat2(sFranchiseTaxAmt,1, 2, 2,True) &  Chr(10)
		End If

		If iHasSeptage = 1 Then
			PrintBuffer = PrintBuffer & "SEWERAGE AND - " & Chr(10) _
					    & "SEPTAGE FEE        " & AddWhiteSpaces(NumberFormat2(sSeptageFeeAmt,1, 2, 2,True)) & NumberFormat2(sSeptageFeeAmt,1, 2, 2,True) &  Chr(10)
		End If
		
		PrintBuffer = PrintBuffer & Chr(27) & "!" & Chr(0) & "ARREARS            " & AddWhiteSpaces(NumberFormat2(sArrearsAmt,1, 2, 2,True)) & NumberFormat2(sArrearsAmt,1, 2, 2,True) &  Chr(10) _
					& Chr(27) & "!" & Chr(0) & "ADVANCES           " & AddWhiteSpaces("(" & NumberFormat2(sAdvPayment,1, 2, 2,True) & ")") & "(" & NumberFormat2(sAdvPayment,1, 2, 2,True) & ")" &  Chr(10) _
					& Chr(27) & "!" & Chr(16) & "TOTAL DUE          " & AddWhiteSpaces(NumberFormat2(sTotalDueAmt,1, 2, 2,True)) & NumberFormat2(sTotalDueAmt,1, 2, 2,True) & Chr(10) _
					& Chr(27) & Chr(97) & Chr(49) _
					& Chr(27) & "!" & Chr(1) & "==========================================" & Chr(10) _
					& Chr(27) & "!" & Chr(8) & "PAYMENT AFTER DUE DATE" & Chr(10) _
					& Chr(27) & Chr(97) & Chr(48) _
					& Chr(27) & "!" & Chr(0) & "DUE DATE           " & AddWhiteSpaces(DueDate) & DueDate &  Chr(10) _
					& Chr(27) & "!" & Chr(0) & "PENALTY            " & AddWhiteSpaces(NumberFormat2(sPenaltyAmt,1, 2, 2,True)) & NumberFormat2(sPenaltyAmt,1, 2, 2,True) &  Chr(10) _
					& Chr(27) & "!" & Chr(0) & "SR. CITIZEN DISC.  " & AddWhiteSpaces("(" & NumberFormat2(sSeniorAfterAmt,1, 2, 2,True) & ")") & "(" & NumberFormat2(sSeniorAfterAmt,1, 2, 2,True) & ")" &  Chr(10) _
					& Chr(27) & "!" & Chr(16) & "TOTAL AMT AFTER DUE" & AddWhiteSpaces(NumberFormat2(sTotalDueAmtAfterSC,1, 2, 2,True)) & NumberFormat2(sTotalDueAmtAfterSC,1, 2, 2,True) & Chr(10) _
					& Chr(27) & "!" & Chr(1) & "==========================================" & Chr(10)
		
		If GlobalVar.SF.Len(BillPeriod3rd) > 0 Then			
			PrintBuffer = PrintBuffer & Chr(27) & Chr(97) & Chr(49) _
					& Chr(27) & "!" & Chr(8) & "CONSUMPTION HISTORY" & Chr(10) _
					& Chr(27) & Chr(97) & Chr(48) _
					& Chr(27) & "!" & Chr(0) & BillPeriod1st & $"           "$ & AddWhiteSpaces(PrevCum1st & $" CuM."$) & PrevCum1st & $" CuM."$ &  Chr(10) _
					& Chr(27) & "!" & Chr(0) & BillPeriod2nd & $"           "$ & AddWhiteSpaces(PrevCum2nd & $" CuM."$) & PrevCum2nd & $" CuM."$ &  Chr(10) _
					& Chr(27) & "!" & Chr(0) & BillPeriod3rd & $"           "$ & AddWhiteSpaces(PrevCum3rd & $" CuM."$) & PrevCum3rd & $" CuM."$ &  Chr(10) _
					& Chr(27) & "!" & Chr(1) & "==========================================" & Chr(10)
		Else If GlobalVar.SF.Len(BillPeriod2nd) > 0 Then
			PrintBuffer = PrintBuffer & Chr(27) & Chr(97) & Chr(49) _
					& Chr(27) & "!" & Chr(8) & "CONSUMPTION HISTORY" & Chr(10) _
					& Chr(27) & Chr(97) & Chr(48) _
					& Chr(27) & "!" & Chr(0) & BillPeriod1st & $"           "$ & AddWhiteSpaces(PrevCum1st & $" CuM."$) & PrevCum1st & $" CuM."$ &  Chr(10) _
					& Chr(27) & "!" & Chr(0) & BillPeriod2nd & $"           "$ & AddWhiteSpaces(PrevCum2nd & $" CuM."$) & PrevCum2nd & $" CuM."$ &  Chr(10) _
					& Chr(27) & "!" & Chr(1) & "==========================================" & Chr(10)
		Else If GlobalVar.SF.Len(BillPeriod1st) > 0 Then
			PrintBuffer = PrintBuffer & Chr(27) & Chr(97) & Chr(49) _
					& Chr(27) & "!" & Chr(8) & "CONSUMPTION HISTORY" & Chr(10) _
					& Chr(27) & Chr(97) & Chr(48) _
					& Chr(27) & "!" & Chr(0) & BillPeriod1st & $"           "$ & AddWhiteSpaces(PrevCum1st & $" CuM."$) & PrevCum1st & $" CuM."$ &  Chr(10) _
					& Chr(27) & "!" & Chr(1) & "==========================================" & Chr(10)
		End If
		
		If (ArrearsAmt > 0) Or (TotalDueAmt >= GDeposit) Then
			PrintBuffer = PrintBuffer & Chr(27) & Chr(97) & Chr(49) _
					      & Chr(27) & "!" & Chr(17) & "NOTICE OF DISCONNECTION" & Chr(10) _
						  & Chr(27) & Chr(97) & Chr(48) _
						  & Chr(27) & "!" & Chr(8) & "DISCONNECTION DATE:" & AddWhiteSpaces(DisconnectionDate) & DisconnectionDate & CRLF & Chr(10) 
'			If GlobalVar.WithDisconDate = 1 Then
'				PrintBuffer = PrintBuffer & Chr(27) & "!" & Chr(0) & "DISCONNECTION DATE " & AddWhiteSpaces(sDisconDate) & sDisconDate & CRLF &  Chr(10)
'			Else
'				sDisconDate = ""
'			End If
			
		End If
		
		PrintBuffer = PrintBuffer & Chr(27) & Chr(97) & Chr(48) _
					  & Chr(27) & "!" & Chr(8) & "NOTE:" &  Chr(10) _
					  & Chr(27) & "!" & Chr(1) & "    Disregard Arrears if Payment has been made. Please pay on or before due date to avoid Disconnection." & CRLF & Chr(10) _
					  & Chr(10) & Chr(27) & Chr(97) & Chr(10)

'		If DBaseFunctions.IsWithDueDate(iReadID) = True Then
'			PrintBuffer = PrintBuffer & Chr(27) & Chr(97) & Chr(48) _
'					& Chr(27) & "!" & Chr(1) & "------------------------------------------" & Chr(10) _
'					& Chr(27) & "!" & Chr(8) & "PAYMENT AFTER DUE DATE" & Chr(10) _
'					& Chr(27) & "!" & Chr(0) & "DUE DATE           " & AddWhiteSpaces(DueDate) & DueDate &  Chr(10) _
'					& Chr(27) & "!" & Chr(0) & "PENALTY            " & AddWhiteSpaces(NumberFormat2(sPenaltyAmt,1, 2, 2,True)) & NumberFormat2(sPenaltyAmt,1, 2, 2,True) &  Chr(10) _
'					& Chr(27) & "!" & Chr(0) & "5% SC DISCOUNT     " & AddWhiteSpaces("(" & NumberFormat2(sSeniorAfterAmt,1, 2, 2,True) & ")") & "(" & NumberFormat2(sSeniorAfterAmt,1, 2, 2,True) & ")" &  Chr(10) _
'					& Chr(27) & "!" & Chr(16) & "TOTAL              " & AddWhiteSpaces(NumberFormat2(sTotalDueAmtAfterSC,1, 2, 2,True)) & NumberFormat2(sTotalDueAmtAfterSC,1, 2, 2,True) & Chr(10) _
'					& Chr(27) & "!" & Chr(1) & "==========================================" & Chr(10)
'		Else
'			PrintBuffer = PrintBuffer & Chr(27) & "!" & Chr(1) & "==========================================" & Chr(10)
'		End If

		StartPrinter
	Catch
		ToastMessageShow($"Unable to Print Bill Statement due to "$ & LastException.Message, True)
		Log(LastException)
	End Try

End Sub

Private Sub RepeatChar(sChar As String, NoOfRepetition As Int) As String
	Dim Totspaces As String

	For i = 1 To NoOfRepetition
		Totspaces = Totspaces & sChar
	Next
	'   Msgbox(totspaces&totspaces.Length,"tot spaces")
	Return Totspaces
End Sub

Private Sub AddWhiteSpaces(sValue As String) As String
	Dim sRetVal As String
	Dim iLen As Int
	Dim sSpace As String
	Dim AddSpace As Int
	Try
		'20 0.00
		iLen = sValue.Length
		AddSpace = 32 - (19 + iLen)
		sSpace = RepeatChar(" ", AddSpace)
		sRetVal = sSpace
	Catch
		Log(LastException)
	End Try
	Return sRetVal
End Sub

Private Sub AddWhiteSpaces2(sValue As String) As String
	Dim sRetVal As String
	Dim iLen As Int
	Dim sSpace As String
	Dim AddSpace As Int
	Try
		'20 0.00
		iLen = sValue.Length
		AddSpace = 32 - (18 + iLen)
		sSpace = RepeatChar(" ", AddSpace)
		sRetVal = sSpace
	Catch
		Log(LastException)
	End Try
	Return sRetVal
End Sub

Sub StartPrinter
	
	PairedDevices.Initialize
	
	Try
		PairedDevices = Serial1.GetPairedDevices
	Catch
		Msgbox("Getting Paired Devices","Printer Error")
		TMPrinter.Close
		Serial1.Disconnect
	End Try

	If PairedDevices.Size = 0 Then
		Msgbox("Error Connecting to Printer - Either No Paired Bluetooth Printer or Printer Not Found!", Application.LabelName)
		Return
	End If
	
	If PairedDevices.Size = 1 Then
		Try
			DeviceName=PairedDevices.Getkeyat(0)
			DeviceMac=PairedDevices.GetValueAt(0)
			Log(DeviceName & " -> " & DeviceMac)
		
'			If DeviceName.Contains("Thermal") Then 'Insert the BT-Name of the printer or use the MAC address
			Serial1.ConnectInsecure(BTAdmin, DeviceMac,1)
			ProgressDialogHide
'			End If
		Catch
			Msgbox("Connecting","Printer Error")
			TMPrinter.Close
			Serial1.Disconnect
		End Try
	Else
		FoundDevices.Initialize

		For i = 0 To PairedDevices.Size - 1
			FoundDevices.Add(PairedDevices.GetKeyAt(i))
			DeviceName=PairedDevices.Getkeyat(i)
			DeviceMac=PairedDevices.GetValueAt(i)
			Log(DeviceName & " -> " & DeviceMac)
'			If DeviceName.Contains("Thermal") Then 'Insert the BT-Name of the printer or use the MAC address
			Serial1.ConnectInsecure(BTAdmin, DeviceMac,1)
			ProgressDialogHide
			Exit
'			End If
		Next

		Res = InputList(FoundDevices, "Choose Device", -1)

		If Res <> DialogResponse.CANCEL Then
			Serial1.Connect(PairedDevices.Get(FoundDevices.Get(Res)))
		End If
	End If
End Sub

Sub Printer_Connected (Success As Boolean)
	Dim iResponse As Object
	Dim csMsg As CSBuilder
	ProgressDialogHide
	Log("Connected: " & Success)

	If Success = False Then
		ProgressDialogHide
		If Not(ConfirmWarning($"Unable to Connect to Printer!"$, $"Printer Error"$, $"Reprint"$, $"Cancel"$, "")) Then
			Return
		End If
		StartPrinter
	Else
		'Printer here
		Dim initPrinter() As Byte

		ProgressDialogHide
		TMPrinter.Initialize2(Serial1.OutputStream, "windows-1252")
		oStream.Initialize(Serial1.InputStream, Serial1.OutputStream, "LogoPrint")
		Logo.Initialize(File.DirAssets, GlobalVar.BranchLogo)
		Logobmp = CreateScaledBitmap(Logo, Logo.Width, Logo.Height)
		Log(DeviceName)

		If strSF.Upper(DeviceName) = "WOOSIM" Then
			WoosimCmd.InitializeStatic("com.woosim.printer.WoosimCmd")
			WoosimImage.InitializeStatic("com.woosim.printer.WoosimImage")
			
			initPrinter = WoosimCmd.RunMethod("initPrinter",Null)
			If GlobalVar.BranchID = 28 Or GlobalVar.BranchID = 29 Or GlobalVar.BranchID = 30 Then
				PrintLogo = WoosimImage.RunMethod("printBitmap", Array (0, 0, 400, 200, Logobmp))
			Else
				PrintLogo = WoosimImage.RunMethod("printBitmap", Array (0, 0, 400, 150, Logobmp))
			End If
			oStream.Write(initPrinter)
			oStream.Write(WoosimCmd.RunMethod("setPageMode",Null))
			oStream.Write(PrintLogo)
			oStream.Write(WoosimCmd.RunMethod("PM_setStdMode",Null))
		Else
			EPSONPrint.Initialize
			PrintLogo =  EPSONPrint.getBytesForBitmap2(GlobalVar.BranchLogo,True)
		End If
		oStream.Write(PrintLogo)
		Sleep(500)
		TMPrinter.WriteLine(PrintBuffer)
		Log(PrintBuffer)
		TMPrinter.Flush
		DispInfoMsg($"Bill Statement successfully printed."$ & $"Tap OK to Continue..."$, $"Bill Printing"$)
		TMPrinter.Close
		Serial1.Disconnect
	End If
End Sub

Sub CreateScaledBitmap(Original As Bitmap, NewWidth As Int, NewHeight As Int) As Bitmap
	Dim r As Reflector
	Dim b As Bitmap
	b = r.RunStaticMethod("android.graphics.Bitmap", "createScaledBitmap", Array As Object(Original, NewWidth, NewHeight, True), Array As String("android.graphics.Bitmap", "java.lang.int", "java.lang.int", "java.lang.boolean"))
	Return b
End Sub

Sub LogoPrint_NewData (Buffer() As Byte)
	Dim msg As String
	msg = BytesToString(Buffer, 0, Buffer.Length, "UTF8")
'	ToastMessageShow(msg, False)
	Log(msg)
End Sub

Sub LogoPrint_Error
'	ToastMessageShow(LastException.Message, True)
'	Log("AStreams_Error")
End Sub

#End Region
#Region High Bill
Private Sub ShowHighBillDialog
	Dim csContent As CSBuilder

	csContent.Initialize.Size(14).Color(Colors.Red).Bold.Append($"WARNING! HIGH BILL DETECTED!"$).Color(Colors.DarkGray).Append(CRLF & $"Customer Reading is TOO HIGH as compared to his/her Previous Reading"$ & CRLF & CRLF & $"Continue posting High Bill Reading anyway?"$).PopAll
	
	MatDialogBuilder.Initialize("PostHighBillReading")
	MatDialogBuilder.Theme(MatDialogBuilder.THEME_LIGHT)
	MatDialogBuilder.Title($"HIGH BILL READING POSTING"$).TitleColor(Colors.Red).TitleGravity(MatDialogBuilder.GRAVITY_START)
	MatDialogBuilder.IconRes(GlobalVar.WarningIcon).LimitIconToDefaultSize
	MatDialogBuilder.Content(csContent)
	MatDialogBuilder.PositiveText($"SAVE AND PRINT"$).PositiveColor(GlobalVar.PriColor)
	MatDialogBuilder.NegativeText($"SAVE ONLY"$).NegativeColor(Colors.Black)
	MatDialogBuilder.NeutralText($"CANCEL POSTING"$).NeutralColor(Colors.Red)
	MatDialogBuilder.CanceledOnTouchOutside(False)
	MatDialogBuilder.Show
End Sub

Sub PostHighBillReading_ButtonPressed (mDialog As MaterialDialog, sAction As String)
	Select Case sAction
		Case mDialog.ACTION_POSITIVE
			sPresentReading = txtPresRdg.Text
'			ShowHighBillConfirmation
			intCurrPos = rsLoadedBook.Position
			SaveReading(1, ReadID, AcctID)
			PrintBillData(ReadID)
			If RetrieveRecords(GlobalVar.BookID)=False Then Return
			If intCurrPos < (RecCount - 1) Then
				rsLoadedBook.Position = intCurrPos + 1
			Else
				rsLoadedBook.Position = intCurrPos
			End If
			DisplayRecord
			ButtonState
			If GetUnusualCount(GlobalVar.BookID) = True Then
				UpdateBadge("Flag", AddBadgeToIcon(flagBitmap, intTotal))
			End If
			vibration.vibrateCancel
		Case mDialog.ACTION_NEGATIVE
			SaveReading(0, ReadID, AcctID)
			If RetrieveRecords(GlobalVar.BookID)=False Then Return
			If intCurrPos < (RecCount - 1) Then
				rsLoadedBook.Position = intCurrPos + 1
			Else
				rsLoadedBook.Position = intCurrPos
			End If
			DisplayRecord
			ButtonState
			If GetUnusualCount(GlobalVar.BookID) = True Then
				UpdateBadge("Flag", AddBadgeToIcon(flagBitmap, intTotal))
			End If
			vibration.vibrateCancel
		Case mDialog.ACTION_NEUTRAL
			snack.Initialize("", Activity, $"Posting Reading Cancelled."$ ,snack.DURATION_SHORT)
			SetSnackBarBackground(snack, Colors.White)
			SetSnackBarTextColor(snack, Colors.Red)
			snack.Show
			vibration.vibrateCancel
			rsLoadedBook.Position= intCurrPos
			DisplayRecord
			ButtonState
			Return
	End Select
End Sub

Private Sub ShowHighBillConfirmation
	MatDialogBuilder.Initialize("HighBillConfirm")
	MatDialogBuilder.Theme(MatDialogBuilder.THEME_LIGHT)
	MatDialogBuilder.Title($"HIGHBILL READING CONFIRMATION"$).TitleColor(Colors.Red).TitleGravity(MatDialogBuilder.GRAVITY_START)
	MatDialogBuilder.Content($"Please Re-enter your current reading for confirmation."$)
	MatDialogBuilder.InputType(MatDialogBuilder.TYPE_CLASS_NUMBER)
	MatDialogBuilder.Input("Re-enter your Reading here...", "")
	MatDialogBuilder.PositiveText($"Save and Print Now"$).PositiveColor(GlobalVar.PriColor)
	MatDialogBuilder.NegativeText($"Cancel"$).NegativeColor(Colors.Red)
	MatDialogBuilder.CanceledOnTouchOutside(False)
	MatDialogBuilder.AlwaysCallInputCallback
	MatDialogBuilder.IconRes("ic_security_black_36dp2").LimitIconToDefaultSize
	MatDialogBuilder.Show
End Sub

Private Sub HighBillConfirm_InputChanged (mDialog As MaterialDialog, sInput As String)
	Dim csBuild As CSBuilder
	If sInput.Length <= 0 Then
		csBuild.Initialize.Bold.Color(Colors.Red).Append($"Please Re-enter your current reading for confirmation."$).PopAll
		mDialog.Content = csBuild
		mDialog.EnableActionButton(mDialog.ACTION_POSITIVE, False)
	Else
		If sInput <> sPresentReading Then
			mDialog.EnableActionButton(mDialog.ACTION_POSITIVE, False)
		Else
			mDialog.EnableActionButton(mDialog.ACTION_POSITIVE, True)
		End If
	End If
End Sub

Private Sub HighBillConfirm_ButtonPressed (mDialog As MaterialDialog, sAction As String)
	Select Case sAction
		Case mDialog.ACTION_POSITIVE
			intCurrPos = rsLoadedBook.Position
			SaveReading(1, ReadID, AcctID)
			PrintBillData(ReadID)
			If RetrieveRecords(GlobalVar.BookID)=False Then Return
			If intCurrPos < (RecCount - 1) Then
				rsLoadedBook.Position = intCurrPos + 1
			Else
				rsLoadedBook.Position = intCurrPos
			End If
			DisplayRecord
			ButtonState
			If GetUnusualCount(GlobalVar.BookID) = True Then
				UpdateBadge("Flag", AddBadgeToIcon(flagBitmap, intTotal))
			End If
			vibration.vibrateCancel
		Case mDialog.ACTION_NEGATIVE
			vibration.vibrateCancel
			Return
	End Select
End Sub
#End Region

#Region Low Bill
Private Sub ShowLowBillDialog
	Dim csContent As CSBuilder

	csContent.Initialize.Size(14).Color(Colors.Red).Bold.Append($"WARNING! LOW BILL DETECTED!"$).Color(Colors.DarkGray).Append(CRLF & $"Customer Reading is TOO LOW as compared to his/her Previous Reading"$ & CRLF & CRLF & $"Continue posting Low Bill Reading anyway?"$).PopAll
	
	MatDialogBuilder.Initialize("PostLowBillReading")
	MatDialogBuilder.Theme(MatDialogBuilder.THEME_LIGHT)
	MatDialogBuilder.Title($"LOW BILL READING POSTING"$).TitleColor(Colors.Red).TitleGravity(MatDialogBuilder.GRAVITY_START)
	MatDialogBuilder.IconRes(GlobalVar.WarningIcon).LimitIconToDefaultSize
	MatDialogBuilder.Content(csContent)
	MatDialogBuilder.PositiveText($"SAVE AND PRINT"$).PositiveColor(GlobalVar.PriColor)
	MatDialogBuilder.NegativeText($"SAVE ONLY"$).NegativeColor(Colors.Black)
	MatDialogBuilder.NeutralText($"CANCEL POSTING"$).NeutralColor(Colors.Red)
	MatDialogBuilder.CanceledOnTouchOutside(False)
	MatDialogBuilder.Show
End Sub

Sub PostLowBillReading_ButtonPressed (mDialog As MaterialDialog, sAction As String)
	Select Case sAction
		Case mDialog.ACTION_POSITIVE
			intCurrPos = rsLoadedBook.Position
			SaveReading(1, ReadID, AcctID)
			PrintBillData(ReadID)
			If RetrieveRecords(GlobalVar.BookID)=False Then Return
			If intCurrPos < (RecCount - 1) Then
				rsLoadedBook.Position = intCurrPos + 1
			Else
				rsLoadedBook.Position = intCurrPos
			End If
			DisplayRecord
			ButtonState
			If GetUnusualCount(GlobalVar.BookID) = True Then
				UpdateBadge("Flag", AddBadgeToIcon(flagBitmap, intTotal))
			End If
			vibration.vibrateCancel
		Case mDialog.ACTION_NEGATIVE
			SaveReading(0, ReadID, AcctID)
			If RetrieveRecords(GlobalVar.BookID)=False Then Return
			If intCurrPos < (RecCount - 1) Then
				rsLoadedBook.Position = intCurrPos + 1
			Else
				rsLoadedBook.Position = intCurrPos
			End If
			DisplayRecord
			ButtonState
			If GetUnusualCount(GlobalVar.BookID) = True Then
				UpdateBadge("Flag", AddBadgeToIcon(flagBitmap, intTotal))
			End If
			vibration.vibrateCancel
		Case mDialog.ACTION_NEUTRAL
			snack.Initialize("", Activity, $"Posting Reading Cancelled."$ ,snack.DURATION_SHORT)
			SetSnackBarBackground(snack, Colors.White)
			SetSnackBarTextColor(snack, Colors.Red)
			snack.Show
			vibration.vibrateCancel
			rsLoadedBook.Position= intCurrPos
			DisplayRecord
			ButtonState
			Return
	End Select
End Sub
#End Region

#Region Normal Reading
Private Sub ShowAddNewReading
	
	Dim csContent, csTitle As CSBuilder
	
	csContent.Initialize.Size(16).Color(Colors.DarkGray).Append($"New Reading ready for Posting..."$).Size(20).Color(Colors.Black).Append(CRLF & $"Save new reading?"$).PopAll
	csTitle.Initialize.Size(20).Bold.Color(Colors.DarkGray).Append($"POST METER READING"$).PopAll

	MatDialogBuilder.Initialize("PostNormalReading")
	MatDialogBuilder.Theme(MatDialogBuilder.THEME_LIGHT)
	MatDialogBuilder.Title(csTitle).TitleGravity(MatDialogBuilder.GRAVITY_START)
	MatDialogBuilder.IconRes(GlobalVar.QuestionIcon).LimitIconToDefaultSize
	MatDialogBuilder.Content(csContent)
	MatDialogBuilder.PositiveText($"SAVE & PRINT"$).PositiveColor(GlobalVar.PriColor)
	MatDialogBuilder.NegativeText($"SAVE ONLY"$).NegativeColor(Colors.Black)
	MatDialogBuilder.NeutralText($"CANCEL"$).NeutralColor(Colors.Red)
	MatDialogBuilder.CanceledOnTouchOutside(False)
	MatDialogBuilder.Show

End Sub

Sub PostNormalReading_ButtonPressed (mDialog As MaterialDialog, sAction As String)
	Select Case sAction
		Case mDialog.ACTION_POSITIVE
			intCurrPos = rsLoadedBook.Position
			SaveReading(1, ReadID, AcctID)
			ProgressDialogShow2($"Bill Statement Printing..."$, False)
			PrintBillData(ReadID)
			If RetrieveRecords(GlobalVar.BookID)=False Then Return
			If intCurrPos < (RecCount - 1) Then
				rsLoadedBook.Position = intCurrPos + 1
			Else
				rsLoadedBook.Position = intCurrPos
			End If
			DisplayRecord
			ButtonState
			If GetUnusualCount(GlobalVar.BookID) = True Then
				UpdateBadge("Flag", AddBadgeToIcon(flagBitmap, intTotal))
			End If
		Case mDialog.ACTION_NEGATIVE
			SaveReading(0, ReadID, AcctID)
			If RetrieveRecords(GlobalVar.BookID)=False Then Return
			If intCurrPos < (RecCount - 1) Then
				rsLoadedBook.Position = intCurrPos + 1
			Else
				rsLoadedBook.Position = intCurrPos
			End If
			DisplayRecord
			ButtonState
			If GetUnusualCount(GlobalVar.BookID) = True Then
				UpdateBadge("Flag", AddBadgeToIcon(flagBitmap, intTotal))
			End If
		Case mDialog.ACTION_NEUTRAL
			snack.Initialize("", Activity, $"Posting Reading Cancelled."$ ,snack.DURATION_SHORT)
			SetSnackBarBackground(snack, Colors.White)
			SetSnackBarTextColor(snack, Colors.Red)
			snack.Show
			rsLoadedBook.Position = intCurrPos
			DisplayRecord
			ButtonState
			Return
	End Select
End Sub

#End Region

#Region Edit Dialog
Private Sub ShowEditDialog
	
	Dim csContent As CSBuilder
	csContent.Initialize.Color(Colors.Red).Append($"WARNING!"$).Color(Colors.DarkGray).Append(CRLF & $"You already Miss Coded this Account."$ & CRLF & $"Continuing this will "$).Color(Colors.Red).Append($"REMOVE "$).Color(Colors.DarkGray).Append($"any Miss Code data on this Account."$).Color(GlobalVar.PriColor).Append(CRLF & CRLF & $"Do you want to Continue anyway?"$).PopAll
	
	MatDialogBuilder.Initialize("EditDialog")
	MatDialogBuilder.Theme(MatDialogBuilder.THEME_LIGHT)
	MatDialogBuilder.Title($"EDIT CURRENT READING"$).TitleColor(Colors.Red).TitleGravity(MatDialogBuilder.GRAVITY_START)
	MatDialogBuilder.IconRes(GlobalVar.WarningIcon).LimitIconToDefaultSize
	MatDialogBuilder.Content(csContent)
	MatDialogBuilder.PositiveText($"YES"$).PositiveColor(GlobalVar.PriColor)
	MatDialogBuilder.NegativeText($"NO"$).NegativeColor(Colors.Red)
	MatDialogBuilder.CanceledOnTouchOutside(False)
	MatDialogBuilder.Show
End Sub

Sub EditDialog_ButtonPressed (mDialog As MaterialDialog, sAction As String)
	Select Case sAction
		Case mDialog.ACTION_POSITIVE
			blnEdit = True
			txtPresRdg.Enabled=True
			txtPresRdg.RequestFocus
			txtPresRdg.SelectionStart=0
			txtPresRdg.SelectAll
			IMEkeyboard.ShowKeyboard(txtPresRdg)
		Case mDialog.ACTION_NEGATIVE
			snack.Initialize("",Activity,$"Editing Reading Cancelled!"$,snack.DURATION_SHORT)
			SetSnackBarBackground(snack, Colors.Red)
			SetSnackBarTextColor(snack, Colors.White)
			snack.Show
	End Select
			
End Sub

#End Region

#Region Search Unusual Reading

Sub btnCancelUnusual_Click
	SearchClosed
	rsLoadedBook.Position = intTempCurrPos
	DisplayRecord
	ButtonState
End Sub

Sub SearchUnsual_ItemClick(Value As String)
	Log(Value)
	SearchFor = Value
	FindSearchRetValue(SearchFor)
	SV.ClearAll
	SearchClosed
End Sub

Private Sub SearchUnsualReading(iFlag As Int)
	Dim SearchList As List

	intTempCurrPos = rsLoadedBook.Position

	If SV.IsInitialized=False Then
		SV.Initialize(Me,"SV")
	End If
	
	SV.ClearAll
	SV.ClearSearchBox
	SV.lv.Clear

	SearchList.Initialize
	SearchList.Clear

	Try
		Select Case iFlag
			Case 0
				Starter.strCriteria="SELECT * FROM tblReadings " & _
									"WHERE WasRead = 1 " & _
									"AND BookID=" & GlobalVar.BookID & " " & _
									"AND BillYear= " & GlobalVar.BillYear & " " & _
									"AND BillMonth=" & GlobalVar.BillMonth & " " & _
									"AND WasMissCoded = 1 " & _
									"ORDER BY SeqNo ASC"

			Case 1
				Starter.strCriteria="SELECT * FROM tblReadings " & _
									"WHERE WasRead = 1 " & _
									"AND BookID=" & GlobalVar.BookID & " " & _
									"AND BillYear= " & GlobalVar.BillYear & " " & _
									"AND BillMonth=" & GlobalVar.BillMonth & " " & _
									"AND ImplosiveType = 'zero' " & _
									"ORDER BY SeqNo ASC"
			Case 2
				Starter.strCriteria="SELECT * FROM tblReadings " & _
									"WHERE WasRead = 1 " & _
									"AND BookID=" & GlobalVar.BookID & " " & _
									"AND BillYear= " & GlobalVar.BillYear & " " & _
									"AND BillMonth=" & GlobalVar.BillMonth & " " & _
									"AND ImplosiveType = 'implosive-inc' " & _
									"ORDER BY SeqNo ASC"

			Case 3
				Starter.strCriteria="SELECT * FROM tblReadings " & _
									"WHERE WasRead = 1 " & _
									"AND BookID=" & GlobalVar.BookID & " " & _
									"AND BillYear= " & GlobalVar.BillYear & " " & _
									"AND BillMonth=" & GlobalVar.BillMonth & " " & _
									"AND ImplosiveType = 'implosive-dec' " & _
									"ORDER BY SeqNo ASC"
		
			Case 4
				Starter.strCriteria="SELECT * FROM tblReadings " & _
									"WHERE WasRead = 1 " & _
									"AND BookID=" & GlobalVar.BookID & " " & _
									"AND BillYear= " & GlobalVar.BillYear & " " & _
									"AND BillMonth=" & GlobalVar.BillMonth & " " & _
									"AND BillType = 'AB' " & _
									"ORDER BY SeqNo ASC"
		End Select
		rsUnusualReading = Starter.DBCon.ExecQuery(Starter.strCriteria)

		If rsUnusualReading.RowCount > 0 Then
			For i = 0 To rsUnusualReading.RowCount - 1
				rsUnusualReading.Position = i
				Dim it As Item
				it.Title=rsUnusualReading.GetString("SeqNo") & " - " & rsUnusualReading.GetString("AcctName")
				it.Text=rsUnusualReading.GetString("AcctAddress")
				it.SearchText=rsUnusualReading.GetString("SeqNo").ToLowerCase
				it.Value=rsUnusualReading.GetString("ReadID")
				SearchList.Add(it)
			Next
			lblUnusualCount.Text = $"    "$ & rsUnusualReading.RowCount & $" Record(s) found..."$
		Else
			lblUnusualCount.Text = $"    No Record found..."$
			Return
		End If
		SV.SetItems(SearchList)
		SearchList.Clear
	Catch
		Log(LastException)
	End Try
End Sub
#End Region

Private Sub ConfirmWarning(sMsg As String, sTitle As String, sPos As String, sNeg As String, sNeu As String) As Boolean
	Dim bRetVal As Boolean
	Dim Response As Object
	Dim icon As B4XBitmap
	Dim csTitle, csMsg As CSBuilder
	
	csTitle.Initialize.Color(Colors.Red).Append(sTitle).PopAll
	
	csMsg.Initialize.Bold.Color(Colors.Red).Append($"ACCESS DENIED!"$).Pop.Pop
	csMsg.Color(Colors.DarkGray).Append(CRLF & sMsg).PopAll
	
	icon = xui.LoadBitmapResize(File.DirAssets, "error.png", 24dip, 24dip, True)
	
	Response = xui.Msgbox2Async(csMsg, csTitle, sPos, sNeu, sNeg, icon)
	If Response = xui.DialogResponse_Positive Then
		bRetVal = True
	Else
		bRetVal = False
	End If
	
	Return bRetVal
	
End Sub

Private Sub DispInfoMsg(sMsg As String, sTitle As String)
	Dim csTitle, csMsg As CSBuilder
	csTitle.Initialize.Color(Colors.Red).Append(sTitle).PopAll
	csMsg.Initialize.Bold.Color(Colors.DarkGray).Append(CRLF & sMsg).PopAll
	
	Msgbox(csMsg, csTitle)
End Sub

Private Sub DispErrorMsg(sMsg As String, sTitle As String) As Boolean
	Dim csTitle, csMsg As CSBuilder
	Dim blnRetVal As Boolean
	Dim iResp As Int
	Dim icon As B4XBitmap
	csTitle.Initialize.Color(Colors.Red).Append(sTitle).PopAll
	csMsg.Initialize.Bold.Color(Colors.DarkGray).Append(CRLF & sMsg).PopAll
	icon = xui.LoadBitmapResize(File.DirAssets, "error.png", 24dip, 24dip, True)
'	Msgbox(csMsg, csTitle)
	iResp =  Msgbox2(csMsg, csTitle, $"OK"$, "","",icon)
	If iResp = DialogResponse.POSITIVE Then
		blnRetVal = True
	Else
		blnRetVal = False
	End If
	Return blnRetVal
End Sub

Private Sub IsPrintableData(iReadID As Int) As Boolean
	Dim blnRetVal As Boolean
	Dim rsValidData As Cursor
	Try
		Starter.strCriteria = "SELECT * FROM tblReadings WHERE ReadID = " & iReadID & " " & _
							  "AND WasRead = 1 " & _
							  "AND WasMissCoded = 0"
		rsValidData = Starter.DBCon.ExecQuery(Starter.strCriteria)
		If rsValidData.RowCount > 0 Then
			blnRetVal = True
		Else
			blnRetVal = False
		End If
	Catch
		blnRetVal = True
		rsValidData.Close
		Log(LastException)
	End Try
	rsValidData.Close
	Return blnRetVal
End Sub

Private Sub ShowFileNotFoundDialog
	Dim csContent As CSBuilder
	Dim csTitle As CSBuilder
	
	csContent.Initialize.Size(14).Color(Colors.Red).Bold.Append($"PICTURE REQUIRED!"$).Pop
	csContent.Color(Colors.DarkGray).Append(CRLF & $"Averaging bill requires picture as proof."$).Color(Colors.Black).Append(CRLF &  $"Do you want to open the camera and capture picture now?"$).PopAll
	csTitle.Initialize.Bold.Size(16).Color(Colors.Red).Append($"PICTURE REQUIRED"$).PopAll

	MatDialogBuilder.Initialize("PictureDialog")
	MatDialogBuilder.Theme(MatDialogBuilder.THEME_LIGHT)
	MatDialogBuilder.Title(csTitle).TitleGravity(MatDialogBuilder.GRAVITY_START)
	MatDialogBuilder.IconRes(GlobalVar.WarningIcon).LimitIconToDefaultSize
	MatDialogBuilder.Content(csContent)
	MatDialogBuilder.PositiveText($"TAKE PHOTO"$).PositiveColor(GlobalVar.PriColor)
	MatDialogBuilder.NegativeText($"CANCEL"$).NegativeColor(Colors.Red)
	MatDialogBuilder.CanceledOnTouchOutside(False)
	MatDialogBuilder.Show
End Sub

Sub PictureDialog_ButtonPressed (mDialog As MaterialDialog, sAction As String)
	Select Case sAction
		Case mDialog.ACTION_POSITIVE
			GlobalVar.isAverage = 1
			Permissions.CheckAndRequest(Permissions.PERMISSION_CAMERA)
			StartActivity(NewCam)
		Case mDialog.ACTION_NEGATIVE
			Return
	End Select
End Sub

Private Sub ShowAverageBillRemarks
	Dim csContent As CSBuilder
	Dim csTitle As CSBuilder
	
	csContent.Initialize.Size(14).Color(Colors.DarkGray).Append($"Please enter remarks/reason."$).PopAll
	csTitle.Initialize.Bold.Size(16).Color(Colors.Red).Append($"POST AVERAGE CONSUMPTION"$).PopAll
	MatDialogBuilder.Initialize("AverageRemarksDialog")
	MatDialogBuilder.Theme(MatDialogBuilder.THEME_LIGHT)
	MatDialogBuilder.Title(csTitle).TitleGravity(MatDialogBuilder.GRAVITY_START)
	MatDialogBuilder.IconRes(GlobalVar.WarningIcon).LimitIconToDefaultSize
	MatDialogBuilder.InputType(Bit.Or(Bit.Or(MatDialogBuilder.TYPE_CLASS_TEXT, MatDialogBuilder.TYPE_TEXT_FLAG_CAP_SENTENCES), MatDialogBuilder.TYPE_TEXT_VARIATION_PERSON_NAME))
	MatDialogBuilder.Input2($"Type your reason here..."$, $""$, False)
	MatDialogBuilder.AlwaysCallInputCallback
	MatDialogBuilder.Content(csContent)
	MatDialogBuilder.PositiveText($"SAVE & PRINT"$).PositiveColor(GlobalVar.PriColor)
	MatDialogBuilder.NegativeText($"SAVE ONLY"$).NegativeColor(Colors.Black)
	MatDialogBuilder.NeutralText($"CANCEL"$).NeutralColor(Colors.Red)
	MatDialogBuilder.CanceledOnTouchOutside(False)
	MatDialogBuilder.Show
End Sub

Sub AverageRemarksDialog_ButtonPressed (mDialog As MaterialDialog, sAction As String)
	Select Case sAction
		Case mDialog.ACTION_POSITIVE
			intCurrPos = rsLoadedBook.Position
			ComputeAverageBill
			SaveAverageBill(1, ReadID, AcctID)
			ProgressDialogShow2($"Bill Statement Printing..."$, False)
			PrintBillData(ReadID)
			If RetrieveRecords(GlobalVar.BookID)=False Then Return
			If intCurrPos < (RecCount - 1) Then
				rsLoadedBook.Position = intCurrPos + 1
			Else
				rsLoadedBook.Position = intCurrPos
			End If
			DisplayRecord
			ButtonState
			If GetUnusualCount(GlobalVar.BookID) = True Then
				UpdateBadge("Flag", AddBadgeToIcon(flagBitmap, intTotal))
			End If
		Case mDialog.ACTION_NEGATIVE
			SaveAverageBill(0, ReadID, AcctID)
			If RetrieveRecords(GlobalVar.BookID)=False Then Return
			If intCurrPos < (RecCount - 1) Then
				rsLoadedBook.Position = intCurrPos + 1
			Else
				rsLoadedBook.Position = intCurrPos
			End If
			DisplayRecord
			ButtonState
			If GetUnusualCount(GlobalVar.BookID) = True Then
				UpdateBadge("Flag", AddBadgeToIcon(flagBitmap, intTotal))
			End If
		Case mDialog.ACTION_NEUTRAL
			snack.Initialize("", Activity, $"Posting Reading Cancelled."$ ,snack.DURATION_SHORT)
			SetSnackBarBackground(snack, Colors.White)
			SetSnackBarTextColor(snack, Colors.Red)
			snack.Show
			rsLoadedBook.Position = intCurrPos
			DisplayRecord
			ButtonState
			Return
	End Select
End Sub

Sub AverageRemarksDialog_InputChanged (mDialog As MaterialDialog, sRemarks As String)
	If sRemarks.Length=0 Then
'		mDialog.Content="Nothing to save."
		mDialog.EnableActionButton(mDialog.ACTION_POSITIVE, False)
		mDialog.EnableActionButton(mDialog.ACTION_NEGATIVE, False)
	Else
'		mDialog.Content="Please Enter a Remarks for this Account."
		mDialog.EnableActionButton(mDialog.ACTION_POSITIVE, True)
		mDialog.EnableActionButton(mDialog.ACTION_NEGATIVE, True)
	End If
	sAveRem = sRemarks
End Sub

'Sub AddRemarksDialog_ButtonPressed (Dialog As MaterialDialog, Action As String)
'	Select Case Action
'		Case Dialog.ACTION_POSITIVE
'			intCurrPos = rsLoadedBook.Position
'			SaveNewRemarks(ReadRemarks, ReadID, AcctID)
'			If RetrieveRecords(GlobalVar.BookID)=False Then Return
'			If intCurrPos < (RecCount - 1) Then
'				rsLoadedBook.Position = intCurrPos + 1
'			Else
'				rsLoadedBook.Position = intCurrPos
'			End If
'			DisplayRecord
'			ButtonState
'		Case Dialog.ACTION_NEGATIVE
'			snack.Initialize("", Activity, $"Adding Reading Remarks Cancelled."$ ,snack.DURATION_SHORT)
'			SetSnackBarBackground(snack, Colors.White)
'			SetSnackBarTextColor(snack, Colors.Red)
'			snack.Show
'			Return
'	End Select
'End Sub

Private Sub ComputeAverageBill
	PresAveRdg = PrevRdg + AveCum

	If Not(IsNumber(PresAveRdg)) Or PresAveRdg.Length <= 0 Then
		PresAveCum = 0
	Else
		
		PresAveCum = AveCum
	End If
End Sub

Private Sub ShowAveNotAvailableDialog
	Dim csContent As CSBuilder
	Dim csTitle As CSBuilder
	
	csContent.Initialize.Size(14).Color(Colors.Red).Bold.Append($"ALREADY READ!"$).Pop
	csContent.Color(Colors.DarkGray).Append(CRLF & $"Unable to generate average bill due to this account was already read."$).PopAll
	csTitle.Initialize.Bold.Size(16).Color(Colors.Red).Append($"E R R O R"$).PopAll

	MatDialogBuilder.Initialize("AveDialogUnavailable")
	MatDialogBuilder.Theme(MatDialogBuilder.THEME_LIGHT)
	MatDialogBuilder.Title(csTitle).TitleGravity(MatDialogBuilder.GRAVITY_START)
	MatDialogBuilder.IconRes(GlobalVar.InfoIcon).LimitIconToDefaultSize
	MatDialogBuilder.Content(csContent)
	MatDialogBuilder.PositiveText($"OK"$).PositiveColor(GlobalVar.PriColor)
	MatDialogBuilder.CanceledOnTouchOutside(False)
	MatDialogBuilder.Show
End Sub

Sub AveDialogUnavailable_ButtonPressed (mDialog As MaterialDialog, sAction As String)
	Select Case sAction
		Case mDialog.ACTION_POSITIVE
			Return
		Case mDialog.ACTION_NEGATIVE
			Return
	End Select
End Sub